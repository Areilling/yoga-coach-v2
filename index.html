<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ§˜ æ™ºæ…§ä½“è‚² Â· ç‘œä¼½è¯„ä¼°</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "PingFang SC", sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      touch-action: none;
    }
    #video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1);
      display: none;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.95);
      z-index: 10;
    }
    #startBtn {
      background: #4fc3f7;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: bold;
    }
    .instructions {
      position: absolute;
      bottom: 20px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      width: 100%;
    }
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  
  <div id="overlay">
    <div style="text-align: center; color: white; font-size: 24px; max-width: 80%;">
      ğŸ§˜ æ™ºæ…§ä½“è‚² Â· ç‘œä¼½ä½“å¼è¯„ä¼°<br>
      <span style="font-size: 16px; color: #bbb; margin-top: 10px; display: block;">
        è¯·åœ¨å…‰çº¿å……è¶³å¤„ä½¿ç”¨
      </span>
    </div>
    <button id="startBtn">ğŸ‘‰ ç‚¹å‡»å¼€å§‹æ‘„åƒå¤´</button>
  </div>
  <div class="instructions">å¾®ä¿¡æ‰«ç ä½¿ç”¨ Â· æ•°æ®ä»…åœ¨æœ¬åœ°å¤„ç†</div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');

    // å…¨å±€å˜é‡
    let detector = null;

    // ç”¨æˆ·ç‚¹å‡»åæ‰åˆå§‹åŒ–ä¸€åˆ‡
    startBtn.addEventListener('click', async () => {
      try {
        // ç¬¬ä¸€æ­¥ï¼šè·å–æ‘„åƒå¤´ï¼ˆå¿…é¡»åœ¨ç”¨æˆ·æ‰‹åŠ¿åï¼‰
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: 640, height: 480 },
          audio: false
        });

        // ç¬¬äºŒæ­¥ï¼šç»‘å®šæµ
        video.srcObject = stream;
        video.style.display = 'block';
        overlay.style.display = 'none';

        // ç¬¬ä¸‰æ­¥ï¼šå¼ºåˆ¶æ’­æ”¾ï¼ˆå…³é”®ï¼ï¼‰
        await video.play();

        // ç¬¬å››æ­¥ï¼šåŠ è½½æ¨¡å‹ï¼ˆå»¶è¿ŸåŠ è½½ï¼Œé¿å…å¡é¡¿ï¼‰
        loadModelAndDetect();
      } catch (err) {
        console.error(err);
        overlay.innerHTML = `<div style="color:#ff6b6b;font-size:18px;text-align:center;">
          âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´<br>
          <span style="font-size:14px;color:#ccc;">è¯·æ£€æŸ¥å¾®ä¿¡æƒé™</span>
          <button id="retryBtn" style="margin-top:15px;background:#ff6b6b;color:white;border:none;padding:10px 20px;border-radius:8px;">
            é‡è¯•
          </button>
        </div>`;
        document.getElementById('retryBtn').onclick = () => location.reload();
      }
    });

    async function loadModelAndDetect() {
      const status = document.createElement('div');
      status.id = 'status';
      status.style.cssText = 'position:absolute;top:20px;width:100%;text-align:center;color:#4fc3f7;font-size:18px;z-index:20;';
      document.body.appendChild(status);
      status.textContent = 'â³ åŠ è½½AIæ¨¡å‹...';

      try {
        await tf.setBackend('webgl');
        detector = await poseDetection.createDetector(
          poseDetection.SupportedModels.BlazePose,
          { runtime: 'tfjs', modelType: 'lite' }
        );
        status.textContent = 'âœ… å‡†å¤‡å°±ç»ªï¼è¯·åšç‘œä¼½...';

        const feedback = document.createElement('div');
        feedback.id = 'feedback';
        feedback.style.cssText = 'position:absolute;top:60px;width:100%;text-align:center;color:white;font-size:20px;z-index:20;';
        document.body.appendChild(feedback);

        // å¼€å§‹æ£€æµ‹
        const detect = async () => {
          if (!detector) return;
          const poses = await detector.estimatePoses(video);
          if (poses.length > 0 && poses[0].keypoints) {
            evaluatePose(poses[0].keypoints, feedback);
          } else {
            feedback.textContent = 'æœªæ£€æµ‹åˆ°äººä½“ï¼Œè¯·å¯¹å‡†é•œå¤´';
          }
          requestAnimationFrame(detect);
        };
        detect();
      } catch (e) {
        console.error(e);
        status.textContent = 'âŒ AIæ¨¡å‹åŠ è½½å¤±è´¥';
      }
    }

    function calculateAngle(a, b, c) {
      if (!a || !b || !c) return 0;
      const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
      let angle = Math.abs(radians * 180 / Math.PI);
      return angle > 180 ? 360 - angle : angle;
    }

    function getPoint(keypoints, index) {
      return keypoints[index] ? { x: keypoints[index].x, y: keypoints[index].y } : null;
    }

    function evaluatePose(keypoints, feedbackEl) {
      const leftHip = getPoint(keypoints, 23);
      const rightHip = getPoint(keypoints, 24);
      const leftKnee = getPoint(keypoints, 25);
      const rightKnee = getPoint(keypoints, 26);
      const leftAnkle = getPoint(keypoints, 27);
      const rightAnkle = getPoint(keypoints, 28);
      const leftShoulder = getPoint(keypoints, 11);
      const rightShoulder = getPoint(keypoints, 12);

      if (!leftHip || !rightHip || !leftKnee || !rightKnee) return;

      const leftKneeAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
      const rightKneeAngle = calculateAngle(rightHip, rightKnee, rightAnkle);

      if ((leftKneeAngle < 120 && rightKneeAngle > 160) || (rightKneeAngle < 120 && leftKneeAngle > 160)) {
        feedbackEl.innerHTML = 'âœ… å•è…¿å¹³è¡¡<br>âœ… éª¨ç›†ç¨³å®š';
        return;
      }

      if (leftShoulder && rightShoulder) {
        const leftArmAngle = calculateAngle(getPoint(keypoints,15), leftShoulder, leftHip);
        const rightArmAngle = calculateAngle(getPoint(keypoints,16), rightShoulder, rightHip);
        if (leftArmAngle > 120 && rightArmAngle > 120) {
          feedbackEl.innerHTML = 'âœ… æ‰‹è‡‚ä¼¸å±•<br>âœ… è„ŠæŸ±å»¶å±•';
          return;
        }
      }

      feedbackEl.textContent = 'è¯·å°è¯•æ ‘å¼æˆ–ä¸‹çŠ¬å¼';
    }
  </script>
</body>
</html>
