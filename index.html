<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ğŸ§˜ æ ‘å¼è¯„ä¼° Â· å•/åŒäºº Â· OKæ‰‹åŠ¿å¯åŠ¨ Â· 3ç§’è‡ªåŠ¨è¯„åˆ†</title>

<!-- TFJS & Pose Detection (BlazePose) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>

<!-- Hands (OKæ‰‹åŠ¿) é‡‡ç”¨ hand-pose-detection + mediapipe runtime -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@2.0.1/dist/hand-pose-detection.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.js"></script>

<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:"PingFang SC",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  .stage{position:relative;width:100vw;height:100vh}
  #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #status,#hud,#fps{position:absolute;left:0;width:100%;text-align:center;z-index:10;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  #status{top:12px;color:#4fc3f7;font-size:14px}
  #hud{top:40px;color:#fff;font-size:16px;font-weight:600}
  #fps{top:68px;color:#bbb;font-size:12px}
  #overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.92);z-index:20}
  .title{font-size:22px;line-height:1.5;text-align:center}
  .subtitle{margin-top:8px;font-size:14px;color:#bbb;text-align:center}
  .controls{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;flex-wrap:wrap;gap:10px;z-index:12;justify-content:center}
  button{background:#4fc3f7;color:#fff;border:none;padding:10px 14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(79,195,247,.25)}
  button.ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
  .legend{position:absolute;right:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-size:12px;color:#ddd;z-index:11}
  .tips{position:absolute;bottom:8px;width:100%;text-align:center;color:#aaa;font-size:12px}
  /* ç»“æœé¢æ¿ */
  #result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,.65);backdrop-filter: blur(2px)}
  .card{max-width:560px;width:90vw;background:rgba(20,20,22,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
  .card h3{font-size:18px;margin-bottom:8px}
  .score{font-size:40px;font-weight:800;margin:6px 0 12px}
  .ok{color:#2ecc71}.bad{color:#ff6b6b}
  ul{margin:8px 0 0 18px;color:#ddd;font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .row>button{flex:1}
  .chip{position:absolute;left:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd;z-index:11}
</style>
</head>
<body>
<div class="stage">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status">â³ å°±ç»ªä¸­â€¦</div>
  <div id="hud"></div>
  <div id="fps"></div>

  <div id="overlay">
    <div class="title">ğŸ§˜ æ ‘å¼è¯„ä¼°ï¼ˆOKæ‰‹åŠ¿å¯åŠ¨ Â· 3ç§’è‡ªåŠ¨è¯„åˆ†ï¼‰</div>
    <div class="subtitle">å…‰çº¿å……è¶³ Â· å…¨èº«å…¥é•œï¼ˆå«è„šè¸ï¼‰ Â· å»ºè®®ä½¿ç”¨ HTTPS</div>
    <div style="height:16px"></div>
    <button id="startBtn">ğŸ‘‰ å¼€å¯æ‘„åƒå¤´</button>
    <div class="subtitle" style="margin-top:10px;">è‹¥å¤±è´¥ï¼šæ£€æŸ¥æ‘„åƒå¤´æƒé™/å…³é—­å ç”¨æ‘„åƒå¤´çš„åº”ç”¨</div>
  </div>

  <div class="controls">
    <button id="switchBtn" class="ghost">åˆ‡æ¢å‰/åæ‘„</button>
    <button id="freezeBtn" class="ghost">ç«‹å³ç»“ç®—</button>
    <button id="saveJsonBtn" class="ghost">ä¸‹è½½è¯„åˆ† JSON</button>
    <button id="shotBtn" class="ghost">ä¿å­˜æˆªå›¾</button>
    <button id="resetBtn" class="ghost">é‡æ–°åŠ è½½</button>
  </div>

  <div class="chip" id="peopleChip">äººæ•°ï¼š--</div>
  <div class="legend">ç»´åº¦ï¼šç›´è…¿ Â· å¼¯è…¿ Â· é«‹å¤–å¼€ Â· æ‰‹ä½ï¼ˆåˆå/OKå¯åŠ¨ï¼‰ Â· è„šä½é«˜åº¦ Â· éª¨ç›†æ°´å¹³ Â· ç¨³å®šåº¦</div>
  <div class="tips">å…¨æœ¬åœ°æ¨ç† Â· ä¸ä¸Šä¼ ä»»ä½•å›¾åƒ/è§†é¢‘</div>

  <!-- ç»“æœå¼¹å±‚ -->
  <div id="result">
    <div class="card">
      <h3 id="resTitle">æ ‘å¼è¯„ä¼°ç»“æœ</h3>
      <div class="score" id="resScore">--</div>
      <div id="resSummary" style="font-size:14px;color:#ccc"></div>
      <ul id="resTips"></ul>
      <div class="row">
        <button id="retryBtn" class="ghost">â†º é‡æ–°æµ‹ä¸€æ¬¡</button>
        <button id="closeBtn">å®Œæˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  // ====== é…ç½®ï¼ˆæ•™ç»ƒç‰ˆ Rubricï¼‰======
  const CFG = {
    backend: 'webgl',
    poseModelType: 'full',
    smoothing: true,

    // é˜ˆå€¼ï¼ˆåƒç´ æŒ‰720på¤§è‡´ç»éªŒå€¼ï¼Œå†…éƒ¨ä¼šåšè‡ªé€‚åº”ï¼‰
    STRAIGHT_MIN: 165,   // ç«™ç«‹è…¿â€œç›´â€ â‰¥165Â°
    BENT_MAX: 120,       // æŠ¬è…¿â€œå¼¯â€ â‰¤120Â°
    VERT_MAX: 0.35,      // ç«™ç«‹è…¿é«‹-è¸â€œå‚ç›´åº¦â€ (xå·®/yå·®) è¶Šå°è¶Šç›´ç«‹
    PELVIS_TILT_MAX: 18, // éª¨ç›†å·¦å³é«˜å·®ï¼ˆåƒç´ ï¼‰â‰¤18
    HOLD_SEC: 3.0,       // âœ… å¯åŠ¨åéœ€é™æ­¢ 3 ç§’è‡ªåŠ¨è¯„åˆ†
    EMA_ALPHA: 0.3,

    // æ‰‹åŠ¿
    OK_DIST_RATIO: 0.18, // OKï¼šæ‹‡æŒ‡å°–-é£ŸæŒ‡å°–è·ç¦» < æ‰‹å¤§å°*è¯¥æ¯”ä¾‹
    PRAYER_WRIST_DIST: 60,   // å›é€€ï¼šåŒè…•å½¼æ­¤è·ç¦»ï¼ˆåƒç´ ï¼‰<=60
    PRAYER_CHEST_DIST: 120,  // å›é€€ï¼šåŒè…•åˆ°èƒ¸ä¸­å¿ƒè·ç¦»ï¼ˆåƒç´ ï¼‰<=120
    STILL_SWAY_TH: 4,    // é™æ­¢é˜ˆå€¼ï¼ˆé«‹ä¸­å¿ƒå¸§é—´ä½ç§»EMAï¼Œåƒç´ ï¼‰

    // è„šä½é«˜åº¦è¯„åˆ†ï¼ˆç›¸å¯¹ç«™ç«‹è…¿ hip/knee/ankleï¼‰
    FOOT_BONUS_AT_GROIN: 1.0,  // æ¥è¿‘å¤§è…¿æ ¹éƒ¨ = æ»¡åˆ†
    FOOT_OK_ABOVE_KNEE: 0.8,   // é«˜äºè†ç›–ä½†æœªåˆ°æ ¹éƒ¨
    FOOT_ON_KNEE: 0.3,         // è„šæ”¾åœ¨è†ç›– = é‡æ‰£
    FOOT_BELOW_KNEE: 0.1,      // è†ä¸‹æ›´ä½ = æ›´é‡æ‰£

    // è¯„åˆ†æƒé‡ï¼ˆæ€»åˆ†100ï¼‰
    W: { straight:20, bent:15, hipOpen:20, hands:10, footHeight:20, pelvis:5, stability:10 }
  };

  // ====== åŸºç¡€å¼•ç”¨ ======
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const resetBtn  = document.getElementById('resetBtn');
  const freezeBtn = document.getElementById('freezeBtn');
  const saveJsonBtn = document.getElementById('saveJsonBtn');
  const shotBtn = document.getElementById('shotBtn');
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const fpsEl = document.getElementById('fps');
  const peopleChip = document.getElementById('peopleChip');

  const resultLayer = document.getElementById('result');
  const resTitle = document.getElementById('resTitle');
  const resScore = document.getElementById('resScore');
  const resSummary = document.getElementById('resSummary');
  const resTips = document.getElementById('resTips');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');

  // ====== çŠ¶æ€ ======
  let facing = 'user';
  let stream = null, poseDetector = null, handsDetector = null;
  let running = false, finalized = false;
  let armed = false;         // â€œå·²å¯åŠ¨ï¼ˆOKæ‰‹åŠ¿ï¼‰â€
  let holdStart = null;      // å¯åŠ¨åç¨³å®šè®¡æ—¶
  let lastCOM = null;        // é«‹ä¸­å¿ƒ
  let swayEma = 0;           // æ‘†åŠ¨EMA
  let lastFPS = 0, frameCnt = 0, lastTS = performance.now();
  let lastPose = null, lastHands = []; // æœ€è¿‘å¸§æ£€æµ‹
  let lastFinal = null;      // æœ€è¿‘ç»“ç®—ç»“æœ

  // ====== å·¥å…· ======
  function fitCanvas() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = canvas.clientWidth || canvas.parentElement.clientWidth;
    const h = canvas.clientHeight || canvas.parentElement.clientHeight;
    canvas.width = Math.round(w * dpr);
    canvas.height = Math.round(h * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    ctx.translate(canvas.clientWidth, 0);
    ctx.scale(-1, 1);
  }
  new ResizeObserver(fitCanvas).observe(canvas);

  async function startCamera(){
    statusEl.textContent='ğŸ“· è¯·æ±‚æ‘„åƒå¤´â€¦';
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{facingMode:facing, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30}}
    });
    video.srcObject=stream; await video.play();
  }

  async function loadModels(){
    statusEl.textContent='ğŸ§  åŠ è½½æ¨¡å‹â€¦';
    await tf.setBackend('webgl'); await tf.ready();

    // Pose
    poseDetector = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime:'tfjs', modelType:CFG.poseModelType, enableSmoothing:CFG.smoothing }
    );

    // Handsï¼ˆmediapipe runtimeï¼Œæœ¬åœ°é™æ€èµ„æºèµ°CDNï¼‰
    handsDetector = await handPoseDetection.createDetector(
      handPoseDetection.SupportedModels.MediaPipeHands,
      {
        runtime: 'mediapipe',
        solutionPath: 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240',
        modelType: 'full', // æ›´ç²¾ç»†
        maxHands: 2
      }
    );
  }

  const ema = ((alpha)=>{ const mem=new Map(); return (k,v)=>{ if(v==null)return null; const last=mem.get(k); const now=(last==null)?v:alpha*v+(1-alpha)*last; mem.set(k,now); return now; } })(CFG.EMA_ALPHA);
  const dist = (a,b)=> (a&&b)? Math.hypot(a.x-b.x,a.y-b.y):null;
  const angleDeg = (a,b,c)=>{ if(!a||!b||!c) return null; const r = Math.atan2(c.y-b.y,c.x-b.x) - Math.atan2(a.y-b.y,a.x-b.x); let d = Math.abs(r*180/Math.PI); return d>180 ? 360-d : d; };
  const vertness = (a,b)=> (a&&b)? (Math.abs(a.x-b.x)/(Math.abs(a.y-b.y)+1e-6)) : null;

  // ç”»éª¨æ¶
  function drawPoseCtx(g, kps){
    if(!kps?.length) return;
    const edges = [
      [11,13],[13,15],[12,14],[14,16],
      [11,12],[23,24],[11,23],[12,24],
      [23,25],[25,27],[24,26],[26,28],
      [27,29],[29,31],[28,30],[30,32]
    ];
    g.lineWidth=3; g.strokeStyle='rgba(79,195,247,.9)'; g.fillStyle='#fff';
    g.beginPath();
    for(const [a,b] of edges){
      const p = kps[a], q = kps[b];
      if(p?.score>.3 && q?.score>.3){ g.moveTo(p.x,p.y); g.lineTo(q.x,q.y); }
    }
    g.stroke();
    for(const p of kps){
      if(p?.score>.3){ g.beginPath(); g.arc(p.x,p.y,4,0,Math.PI*2); g.fill(); }
    }
  }
  function drawHandsCtx(g, hands){
    g.strokeStyle='rgba(255,255,255,.8)'; g.lineWidth=2; g.fillStyle='#4fc3f7';
    for(const h of hands){
      for(const p of h.keypoints || []){
        g.beginPath(); g.arc(p.x,p.y,3,0,Math.PI*2); g.fill();
      }
    }
  }

  // é€‰æ‹©ä¸»è§’ï¼ˆæœ€å¤š2äººï¼‰ï¼šæŒ‰å¯è§å…³é”®ç‚¹åŒ…å›´ç›’é¢ç§¯ä¸ä¸­å¿ƒæ¥è¿‘ç”»é¢ä¸­å¿ƒç»¼åˆæ’åº
  function pickPrimary(poses){
    if(!poses?.length) return null;
    const center = {x: canvas.clientWidth/2, y: canvas.clientHeight/2};
    const scored = poses.map(p=>{
      const xs = p.keypoints.filter(k=>k.score==null||k.score>0.3).map(k=>k.x);
      const ys = p.keypoints.filter(k=>k.score==null||k.score>0.3).map(k=>k.y);
      if(!xs.length||!ys.length) return {p,score:-1};
      const minx=Math.min(...xs), maxx=Math.max(...xs), miny=Math.min(...ys), maxy=Math.max(...ys);
      const area = (maxx-minx)*(maxy-miny);
      const cx = (minx+maxx)/2, cy=(miny+maxy)/2;
      const d = Math.hypot(cx-center.x, cy-center.y)+1;
      const score = area / d; // å¤§ä¸”å±…ä¸­åˆ†é«˜
      return {p, score};
    }).sort((a,b)=>b.score-a.score);
    return scored[0].p;
  }

  // â€”â€” OK æ‰‹åŠ¿ï¼šæ‹‡æŒ‡å°–-é£ŸæŒ‡å°–è·ç¦» / æ‰‹æŒå°ºåº¦
  function isOkGesture(h){
    if(!h?.keypoints3D && !h?.keypoints) return false;
    // Mediapipe Hands ç´¢å¼•ï¼š4=æ‹‡æŒ‡å°–ï¼Œ8=é£ŸæŒ‡å°–ï¼Œ0=æ‰‹è…•ï¼Œ9/13=æŒå¿ƒé™„è¿‘
    const kp = h.keypoints;
    const thumb = kp[4], index = kp[8], wrist = kp[0], mcpIndex = kp[5], mcpPink = kp[17];
    if(!thumb||!index||!wrist||!mcpIndex||!mcpPink) return false;
    const palm = dist(mcpIndex, mcpPink) || 1; // æ‰‹æŒå®½åº¦è¿‘ä¼¼
    const tip = dist(thumb, index) || 9999;
    const ratio = tip / palm;
    return ratio < CFG.OK_DIST_RATIO; // è¶Šå°è¶ŠåƒOK
  }

  // â€”â€” èƒ¸å‰åˆåï¼ˆå›é€€å¯åŠ¨æ¡ä»¶ï¼‰ï¼šä»¥åŒè…•é è¿‘ + é è¿‘èƒ¸ä¸­å¿ƒä¼°è®¡
  function isPrayerFallback(kps){
    const ls = kps[11], rs = kps[12], lw = kps[15], rw = kps[16];
    if(!(ls&&rs&&lw&&rw)) return false;
    const chest = {x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2};
    const wristsClose = (dist(lw,rw)||9999) <= CFG.PRAYER_WRIST_DIST;
    const wristsNearChest = (dist(lw,chest)||9999) <= CFG.PRAYER_CHEST_DIST && (dist(rw,chest)||9999) <= CFG.PRAYER_CHEST_DIST;
    return wristsClose && wristsNearChest;
  }

  // â€”â€” æ ‘å¼è¯„åˆ†
  function scoreTree(kps){
    // ç´¢å¼•ï¼šé«‹(23,24) è†(25,26) è¸(27,28) è‚©(11,12) è…•(15,16)
    const lh=kps[23], rh=kps[24], lk=kps[25], rk=kps[26], la=kps[27], ra=kps[28], ls=kps[11], rs=kps[12], lw=kps[15], rw=kps[16];
    if(!lh||!rh||!lk||!rk||!la||!ra) return {ok:false, score:0, problems:['å…³é”®ç‚¹ä¸è¶³'], detail:{}};

    const hipMid = {x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2};

    // ä¸¤ä¾§è§’åº¦
    const LKA = angleDeg(lh, lk, la); // å·¦è†è§’
    const RKA = angleDeg(rh, rk, ra); // å³è†è§’

    // ç«™ç«‹è…¿åˆ¤æ–­ï¼šè°æ›´ç›´ä¸”æ›´å‚ç›´
    const vL = vertness(lh, la);
    const vR = vertness(rh, ra);
    const leftStandScore  = ((LKA||0) - CFG.STRAIGHT_MIN) + ((CFG.VERT_MAX - (vL||999)));
    const rightStandScore = ((RKA||0) - CFG.STRAIGHT_MIN) + ((CFG.VERT_MAX - (vR||999)));
    const standLeft = leftStandScore >= rightStandScore;

    const standHip   = standLeft ? lh : rh;
    const standKnee  = standLeft ? lk : rk;
    const standAnkle = standLeft ? la : ra;
    const liftHip    = standLeft ? rh : lh;
    const liftKnee   = standLeft ? rk : lk;
    const liftAnkle  = standLeft ? ra : la;

    // ç›´è…¿/å¼¯è…¿/å‚ç›´/éª¨ç›†
    const straight = standLeft ? LKA : RKA;
    const bent     = standLeft ? RKA : LKA;
    const vert     = standLeft ? vL  : vR;
    const pelvisTilt = Math.abs(lh.y - rh.y);

    // é«‹å¤–å¼€ï¼ˆæŠ¬è…¿è†ç›–ç›¸å¯¹é«‹ä¸­å¿ƒå‘å¤–çš„ç¨‹åº¦ï¼‰ï¼šç”¨æ°´å¹³æ–¹å‘è·ç¦»å è‚©å®½æ¯”ä¾‹
    const shoulderW = (ls&&rs)? Math.max(40, Math.abs(ls.x - rs.x)) : 200;
    const kneeOut = Math.abs(liftKnee.x - hipMid.x) / shoulderW; // è¶Šå¤§è¶Šå¤–å¼€ï¼ˆé•œåƒå·²å¤„ç†ï¼Œä¸çœ‹å·¦å³æ–¹å‘ï¼‰

    // æ‰‹ä½ï¼ˆåˆåï¼‰ï¼šé»˜è®¤ç”¨ Handsï¼›è‹¥ hands ä¸å¯ç”¨ï¼Œç”¨ wrists å›é€€
    let handsScore = 0;
    let handsOk = false;
    if (lastHands?.length) {
      handsOk = lastHands.some(h => isOkGesture(h)); // ä»»ä¸€æ‰‹åšOKå³å¯â€œå¯åŠ¨â€ï¼›è¯„åˆ†ä»ä»¥â€œåˆåâ€è¿‘èƒ¸æ¥è¡¡é‡
    }
    // åˆåè¯„åˆ†ï¼ˆå›é€€ç­–ç•¥ä¹Ÿå¯ç”¨äºè¯„åˆ†ï¼‰
    const chest = (ls&&rs)? {x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2} : null;
    if (lw&&rw&&chest) {
      const wristsClose = (dist(lw,rw)||9999);
      const wristsChest = Math.min(dist(lw,chest)||9999, dist(rw,chest)||9999);
      const closeScore = Math.max(0, Math.min(1, (120 - wristsClose)/120));
      const chestScore = Math.max(0, Math.min(1, (150 - wristsChest)/150));
      handsScore = (closeScore*0.6 + chestScore*0.4);
    }

    // è„šä½é«˜åº¦è¯„åˆ†ï¼ˆç›¸å¯¹ç«™ç«‹è…¿ hip/knee/ankle ä¸‰ä¸ªyä½ï¼‰
    // yè¶Šå°è¶Šé«˜ï¼›ç”¨ lifted heel(ankle) çš„é«˜åº¦ä¸ hip/knee/ankle çš„ç›¸å¯¹åŒºé—´å½’ä¸€
    let footHeightScore = 0, footRemark='';
    if (liftAnkle && standHip && standKnee && standAnkle) {
      const top = standHip.y, mid = standKnee.y, bot = standAnkle.y;
      const ay = liftAnkle.y;
      if (ay <= top + 12) { footHeightScore = CFG.FOOT_BONUS_AT_GROIN; footRemark='è„šè·Ÿæ¥è¿‘å¤§è…¿æ ¹éƒ¨'; }
      else if (ay < mid - 6) { footHeightScore = CFG.FOOT_OK_ABOVE_KNEE; footRemark='é«˜äºè†ç›–'; }
      else if (Math.abs(ay - mid) <= 12) { footHeightScore = CFG.FOOT_ON_KNEE; footRemark='è„šè¸©åœ¨è†ç›–ï¼ˆé‡æ‰£ï¼‰'; }
      else { footHeightScore = CFG.FOOT_BELOW_KNEE; footRemark='è†ä¸‹æ›´ä½ï¼ˆæ‰£åˆ†ï¼‰'; }
    }

    // ç¨³å®šåº¦ï¼ˆé«‹ä¸­å¿ƒç§»åŠ¨è¶Šå°è¶Šé«˜ï¼‰
    const swayTh = 6;
    const s_stab = Math.max(0, Math.min(1, (swayTh - (swayEma||swayTh)) / swayTh));

    // å½’ä¸€å¾—åˆ†
    const s_straight = Math.max(0, Math.min(1, (straight - CFG.STRAIGHT_MIN) / (180 - CFG.STRAIGHT_MIN)));
    const s_bent     = Math.max(0, Math.min(1, (CFG.BENT_MAX - bent) / CFG.BENT_MAX));
    const s_vert     = Math.max(0, Math.min(1, (CFG.VERT_MAX - vert) / CFG.VERT_MAX));
    const s_hipOpen  = Math.max(0, Math.min(1, kneeOut / 0.55)); // 0.55â‰ˆå¤–å¼€å……åˆ†
    const s_pelvis   = Math.max(0, Math.min(1, (CFG.PELVIS_TILT_MAX - pelvisTilt)/CFG.PELVIS_TILT_MAX));
    const s_hands    = handsScore; // 0~1
    const s_footH    = footHeightScore; // å·²åœ¨ä¸Šé¢æŒ‰æ¡£æ˜ å°„

    const score =
      s_straight*CFG.W.straight +
      s_bent*CFG.W.bent +
      s_hipOpen*CFG.W.hipOpen +
      s_hands*CFG.W.hands +
      s_footH*CFG.W.footHeight +
      s_pelvis*CFG.W.pelvis +
      s_stab*CFG.W.stability;

    // é—®é¢˜ç‚¹
    const problems = [];
    if(s_straight<0.8) problems.push('ç«™ç«‹è…¿éœ€æ›´ç›´');
    if(s_bent<0.8) problems.push('æŠ¬è…¿è†ç›–å†æ”¶ç´§ï¼ˆæ›´å¼¯ï¼‰');
    if(s_hipOpen<0.8) problems.push('é«‹å…³èŠ‚å¤–å¼€ä¸è¶³ï¼ˆè†ç›–å‘å¤–ï¼‰');
    if(s_hands<0.8) problems.push('åŒæ‰‹èƒ¸å‰åˆåï¼ˆé è¿‘èƒ¸ä¸­å¿ƒï¼‰');
    if(footRemark.includes('è†ç›–')) problems.push('é¿å…è„šè¸©åœ¨è†ç›–ï¼ˆæ”¹ä¸ºè´´å¤§è…¿å†…ä¾§ï¼‰');
    if(s_footH<0.8 && !footRemark.includes('è†ç›–')) problems.push('è„šè·Ÿå°½é‡å‘ä¸Šï¼Œè´´è¿‘å¤§è…¿æ ¹éƒ¨');
    if(s_pelvis<0.8) problems.push('éª¨ç›†ä¿æŒæ°´å¹³');
    if(s_stab<0.8) problems.push('ä¿æŒç¨³å®šï¼Œå‡å°‘ä¸Šèº«æ‘†åŠ¨');

    return {
      ok:true,
      score: Math.round(score),
      problems,
      detail: {
        standLeft, LKA:Math.round(LKA||0), RKA:Math.round(RKA||0),
        vert:+(vert||0).toFixed(2), pelvisTilt:Math.round(pelvisTilt||0),
        kneeOut:+kneeOut.toFixed(2), handsScore:+s_hands.toFixed(2),
        footRemark
      }
    };
  }

  // â€”â€” æœ€ç»ˆå±•ç¤º
  function finalize(res){
    finalized = true; running=false;
    const s = res.score;
    resTitle.textContent = 'æ ‘å¼è¯„ä¼°ç»“æœ';
    resScore.textContent = `${s} åˆ†`;
    resScore.className = 'score ' + (s>=85?'ok':(s>=60?'':'bad'));
    resSummary.textContent = s>=85 ? 'å§¿åŠ¿è§„èŒƒï¼Œä¿æŒè‰¯å¥½ï¼' : (s>=60 ? 'åŸºæœ¬è¾¾æ ‡ï¼Œæ³¨æ„ç»†èŠ‚è°ƒæ•´ã€‚' : 'æœªè¾¾æ ‡ï¼Œå»ºè®®æ ¹æ®æç¤ºé€é¡¹çº æ­£ã€‚');
    resTips.innerHTML = '';
    (res.problems?.length?res.problems:['æ— æ˜æ˜¾é—®é¢˜ç‚¹']).forEach(t=>{
      const li=document.createElement('li'); li.textContent=t; resTips.appendChild(li);
    });
    lastFinal = {
      timestamp: new Date().toISOString(),
      score: s,
      problems: res.problems,
      detail: res.detail,
      config: CFG
    };
    document.getElementById('result').style.display='flex';
  }

  // â€”â€” å¯¼å‡º
  function download(filename, blob){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 800);
  }
  function saveJSON(){
    const base = lastFinal ?? {
      timestamp: new Date().toISOString(),
      score: scoreTree(lastPose?.keypoints || []).score,
      problems: ['å³æ—¶å¿«ç…§ï¼ˆæœªç»“ç®—ï¼‰'],
      detail: null, config: CFG
    };
    const payload = {
      ...base,
      device:{ ua:navigator.userAgent, res:`${video.videoWidth}x${video.videoHeight}` }
    };
    download(`tree_pose_${new Date().toISOString().replace(/[:.]/g,'-')}.json`,
      new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  }
  function saveScreenshot(){
    const w = canvas.clientWidth, h=canvas.clientHeight;
    const off = document.createElement('canvas'); off.width=w; off.height=h;
    const g = off.getContext('2d');
    g.translate(w,0); g.scale(-1,1);
    try{ g.drawImage(video,0,0,w,h); }catch(e){}
    drawPoseCtx(g, lastPose?.keypoints||[]);
    drawHandsCtx(g, lastHands||[]);
    g.setTransform(1,0,0,1,0,0);
    g.fillStyle='rgba(0,0,0,.5)'; g.fillRect(10,10,320,26);
    g.fillStyle='#fff'; g.font='14px system-ui, sans-serif';
    g.fillText(`Tree Pose Â· ${new Date().toLocaleString()}`, 18, 29);
    off.toBlob(b=>{
      download(`tree_pose_${new Date().toISOString().replace(/[:.]/g,'-')}.png`, b);
    },'image/png');
  }

  // ====== ä¸»å¾ªç¯ ======
  async function loop(){
    if(!running) return;
    try{
      // 1) Poseï¼ˆå–æœ€å¤š2ä¸ªï¼Œé€‰ä¸»è§’ï¼‰
      const poses = await poseDetector.estimatePoses(video,{flipHorizontal:false});
      peopleChip.textContent = `äººæ•°ï¼š${poses.length||0}`;
      if(poses.length>1) hudEl.textContent = 'æ£€æµ‹åˆ° 2 äººï¼Œä»…è¯„åˆ†ä¸»è§’ï¼ˆé¢ç§¯æ›´å¤§/æ›´å±…ä¸­ï¼‰';

      const primary = pickPrimary(poses) || poses[0];
      lastPose = primary;

      // 2) Handsï¼ˆOK æ‰‹åŠ¿ï¼‰
      try {
        lastHands = await handsDetector.estimateHands(video, { flipHorizontal:false });
      } catch (e) {
        lastHands = []; // å¤±è´¥æ—¶å›é€€
      }

      // 3) ç»˜åˆ¶
      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawPoseCtx(ctx, primary?.keypoints||[]);
      drawHandsCtx(ctx, lastHands||[]);

      // 4) ç¨³å®š/å¯åŠ¨é€»è¾‘
      let hud = '';
      if (!primary?.keypoints?.length) {
        hud = 'æœªæ£€æµ‹åˆ°äººä½“ï¼šè¯·æ­£å¯¹é•œå¤´ï¼Œç¡®ä¿å…¨èº«å…¥é•œï¼ˆå«è„šè¸ï¼‰';
        armed = false; holdStart = null;
      } else {
        // é«‹ä¸­å¿ƒæ‘†åŠ¨
        const lh=primary.keypoints[23], rh=primary.keypoints[24];
        const hipMid = (lh&&rh)? {x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2} : null;
        if(hipMid && lastCOM){
          const move = dist(hipMid,lastCOM)||0;
          swayEma = ema('sway', move) ?? move;
        }
        lastCOM = hipMid;

        // OK/åˆåå¯åŠ¨
        const okByHands = lastHands.some(h=>isOkGesture(h));
        const prayerFallback = isPrayerFallback(primary.keypoints);
        const still = (swayEma||0) < CFG.STILL_SWAY_TH;

        if (!armed) {
          if (still && (okByHands || prayerFallback)) {
            armed = true;
            holdStart = performance.now(); // å¯åŠ¨å³å¼€å§‹é™æ­¢è®¡æ—¶
            statusEl.textContent = 'âœ… å·²å¯åŠ¨ï¼šè¯·ä¿æŒæ ‘å¼ä¸åŠ¨ 3 ç§’â€¦';
          }
          hud = `ç­‰å¾…å¯åŠ¨ï¼šè¯·ç«™å®šå¹¶åšOKæ‰‹åŠ¿ï¼ˆæˆ–åŒæ‰‹èƒ¸å‰åˆåï¼‰ Â· æ‘†åŠ¨=${(swayEma||0).toFixed(1)}`;
        } else {
          // å·²å¯åŠ¨ â†’ è®¡æ—¶3ç§’
          const sec = (performance.now() - (holdStart||performance.now()))/1000;
          hud = `â± å·²å¯åŠ¨ï¼Œä¿æŒä¸åŠ¨â€¦ ${Math.min(CFG.HOLD_SEC, sec).toFixed(1)}/${CFG.HOLD_SEC}s`;
          if (sec >= CFG.HOLD_SEC) {
            const res = scoreTree(primary.keypoints);
            finalize(res);
            return;
          }
        }
      }
      hudEl.textContent = hud;

      // 5) FPSæ˜¾ç¤º
      frameCnt++; const now=performance.now();
      if(now-lastTS>=1000){ lastFPS=frameCnt; frameCnt=0; lastTS=now; }
      fpsEl.textContent = `FPS:${lastFPS} Â· åˆ†è¾¨ç‡ ${video.videoWidth}Ã—${video.videoHeight}`;

    }catch(e){
      console.error(e);
      statusEl.textContent='âŒ æ£€æµ‹å¼‚å¸¸'; hudEl.textContent='ç‚¹å‡»â€œé‡æ–°åŠ è½½â€å†è¯•';
    }
    requestAnimationFrame(loop);
  }

  // ====== äº‹ä»¶ ======
  startBtn.addEventListener('click', async ()=>{
    try{
      await startCamera(); overlay.style.display='none'; fitCanvas();
      await loadModels();
      running=true; finalized=false; armed=false; holdStart=null; swayEma=0; lastFinal=null;
      statusEl.textContent='âœ… æ¨¡å‹å°±ç»ªï¼šç«™å®šå¹¶åšOKæ‰‹åŠ¿ä»¥å¼€å§‹';
      loop();
    }catch(e){
      console.error(e);
      statusEl.textContent='âŒ å¯åŠ¨å¤±è´¥'; overlay.style.display='';
    }
  });
  switchBtn.addEventListener('click', async ()=>{
    facing = (facing==='user') ? 'environment' : 'user';
    try{ await startCamera(); }catch(e){ console.error(e); }
  });
  resetBtn.addEventListener('click', ()=> location.reload());

  freezeBtn.addEventListener('click', ()=>{
    if(finalized) return;
    if(!lastPose?.keypoints?.length){ statusEl.textContent='æš‚æœªæ£€æµ‹åˆ°äººä½“/å…³é”®ç‚¹'; return; }
    finalize( scoreTree(lastPose.keypoints) );
  });

  saveJsonBtn.addEventListener('click', saveJSON);
  shotBtn.addEventListener('click', saveScreenshot);

  retryBtn.addEventListener('click', ()=>{
    document.getElementById('result').style.display='none';
    finalized=false; armed=false; holdStart=null; swayEma=0; lastFinal=null;
    running=true; statusEl.textContent='â†º å·²å¤ä½ï¼šç«™å®š+OKæ‰‹åŠ¿ä»¥å¼€å§‹'; loop();
  });
  closeBtn.addEventListener('click', ()=> { document.getElementById('result').style.display='none'; });

  if(!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    statusEl.textContent='âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´'; startBtn.disabled=true;
  }
})();
</script>
</body>
</html>
