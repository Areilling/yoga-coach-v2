<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ğŸ§˜ æ ‘å¼è¯„ä¼° Â· æé€Ÿç²¾ç®€ç‰ˆï¼ˆLiteï¼‰</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:"PingFang SC",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  .stage{position:relative;width:100vw;height:100vh}
  #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #status,#hud,#fps{position:absolute;left:0;width:100%;text-align:center;z-index:10;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  #status{top:12px;color:#4fc3f7;font-size:14px}
  #hud{top:40px;color:#fff;font-size:16px;font-weight:600}
  #fps{top:68px;color:#bbb;font-size:12px}
  #overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.92);z-index:20}
  .title{font-size:22px;line-height:1.5;text-align:center}
  .subtitle{margin-top:8px;font-size:14px;color:#bbb;text-align:center;max-width:86vw}
  .controls{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;flex-wrap:wrap;gap:10px;z-index:12;justify-content:center}
  button{background:#4fc3f7;color:#fff;border:none;padding:10px 14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(79,195,247,.25)}
  button.ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
  .legend{position:absolute;right:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-size:12px;color:#ddd;z-index:11}
  .chip{position:absolute;left:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd;z-index:11}
  .tips{position:absolute;bottom:8px;width:100%;text-align:center;color:#aaa;font-size:12px}
  #log{position:absolute;left:8px;top:96px;right:8px;color:#bbb;font-size:11px;white-space:pre-wrap;z-index:10}
  /* ç»“æœé¢æ¿ */
  #result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,.65);backdrop-filter: blur(2px)}
  .card{max-width:560px;width:90vw;background:rgba(20,20,22,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
  .card h3{font-size:18px;margin-bottom:8px}
  .score{font-size:40px;font-weight:800;margin:6px 0 12px}
  .ok{color:#2ecc71}.bad{color:#ff6b6b}
  ul{margin:8px 0 0 18px;color:#ddd;font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .row>button{flex:1}
</style>
</head>
<body>
<div class="stage">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status">â³ å°±ç»ªä¸­â€¦</div>
  <div id="hud"></div>
  <div id="fps"></div>
  <pre id="log"></pre>

  <div id="overlay">
    <div class="title">ğŸ§˜ æ ‘å¼è¯„ä¼° Â· æé€Ÿç²¾ç®€ç‰ˆ</div>
    <div class="subtitle">ä¸ºä¿è¯é€Ÿåº¦ï¼Œæœ¬ç‰ˆä»…åŠ è½½ Pose æ¨¡å‹ï¼ˆä¸åŠ è½½æ‰‹éƒ¨æ¨¡å‹ï¼‰ã€‚<br>å¯åŠ¨æ–¹å¼ï¼š<b>ç«™å®š + èƒ¸å‰åˆå</b>ï¼Œä¿æŒé™æ­¢<b>3ç§’</b>è‡ªåŠ¨è¯„åˆ†ã€‚</div>
    <div style="height:16px"></div>
    <button id="startBtn">ğŸ‘‰ å¼€å¯æ‘„åƒå¤´ï¼ˆLiteï¼‰</button>
    <div class="subtitle" style="margin-top:10px;">æ‰“ä¸å¼€ï¼Ÿè¯·ç”¨ HTTPSã€æ¢ 4G/5Gï¼Œæˆ–ç”¨ PC + åŒä¸€Wi-Fiä¸‹çš„å†…ç½‘IPè®¿é—®ã€‚</div>
  </div>

  <div class="controls">
    <button id="switchBtn" class="ghost">åˆ‡æ¢å‰/åæ‘„</button>
    <button id="freezeBtn" class="ghost">ç«‹å³ç»“ç®—</button>
    <button id="saveJsonBtn" class="ghost">ä¸‹è½½è¯„åˆ† JSON</button>
    <button id="shotBtn" class="ghost">ä¿å­˜æˆªå›¾</button>
    <button id="resetBtn" class="ghost">é‡æ–°åŠ è½½</button>
  </div>

  <div class="chip" id="peopleChip">äººæ•°ï¼š--</div>
  <div class="legend">ç»´åº¦ï¼šç›´è…¿ Â· å¼¯è…¿ Â· é«‹å¤–å¼€ Â· æ‰‹ä½ï¼ˆåˆåï¼‰ Â· è„šä½é«˜åº¦ Â· éª¨ç›†æ°´å¹³ Â· ç¨³å®šåº¦</div>
  <div class="tips">å…¨æœ¬åœ°æ¨ç† Â· ä¸ä¸Šä¼ ä»»ä½•å›¾åƒ/è§†é¢‘</div>

  <!-- ç»“æœå¼¹å±‚ -->
  <div id="result">
    <div class="card">
      <h3 id="resTitle">æ ‘å¼è¯„ä¼°ç»“æœ</h3>
      <div class="score" id="resScore">--</div>
      <div id="resSummary" style="font-size:14px;color:#ccc"></div>
      <ul id="resTips"></ul>
      <div class="row">
        <button id="retryBtn" class="ghost">â†º é‡æ–°æµ‹ä¸€æ¬¡</button>
        <button id="closeBtn">å®Œæˆ</button>
      </div>
    </div>
  </div>
</div>

<!-- å¤šCDNå®¹é”™åŠ è½½ï¼štfjs + pose-detection -->
<script>
const LOG = (s)=>{ document.getElementById('log').textContent += (s+'\n'); };
const SCRIPTS = [
  ["https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js",
   "https://unpkg.com/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"],
  ["https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js",
   "https://unpkg.com/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"],
  ["https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js",
   "https://unpkg.com/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"],
  ["https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js",
   "https://unpkg.com/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"]
];
function loadOne(url){return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=url; s.onload=res; s.onerror=()=>rej(url); document.head.appendChild(s); });}
async function loadScripts(){
  for (const mirrors of SCRIPTS){
    let ok=false, lastErr='';
    for(const url of mirrors){
      try{ LOG('ğŸ“¥ è„šæœ¬åŠ è½½ï¼š'+url); await loadOne(url); ok=true; break; } catch(e){ lastErr=e; LOG('âš ï¸ å¤±è´¥ï¼š'+e); }
    }
    if(!ok) throw new Error('CDNå…¨å¤±è´¥ï¼š'+mirrors[0]);
  }
}
</script>

<script>
(async () => {
  const CFG = {
    backend: 'webgl',
    poseModelType: 'lite',   // â† æé€Ÿå…³é”®
    smoothing: true,

    // è§†é¢‘ä¸é‡‡æ ·
    video: { width:640, height:480, fps:24 }, // â† æé€Ÿå…³é”®
    sampleEveryN: 1, // éœ€è¦æ›´å¿«å¯è®¾2ï¼Œè¡¨ç¤ºéš”å¸§æ¨ç†

    // åˆ¤å®šé˜ˆå€¼
    STRAIGHT_MIN: 165,
    BENT_MAX: 120,
    VERT_MAX: 0.40,      // liteæ›´å®½æ¾
    PELVIS_TILT_MAX: 22, // liteæ›´å®½æ¾
    HOLD_SEC: 3.0,       // åˆåå¯åŠ¨åé™æ­¢3ç§’è¯„åˆ†
    EMA_ALPHA: 0.3,
    STILL_SWAY_TH: 5,    // liteæ›´å®½æ¾

    // æ‰‹ä½ï¼ˆåˆåå›é€€ï¼‰
    PRAYER_WRIST_DIST: 70,
    PRAYER_CHEST_DIST: 140,

    // è„šä½é«˜åº¦è¯„åˆ†
    FOOT_BONUS_AT_GROIN: 1.0,
    FOOT_OK_ABOVE_KNEE: 0.8,
    FOOT_ON_KNEE: 0.3,
    FOOT_BELOW_KNEE: 0.1,

    // è¯„åˆ†æƒé‡
    W: { straight:20, bent:15, hipOpen:20, hands:10, footHeight:20, pelvis:5, stability:10 }
  };

  // DOM
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  const overlay = document.getElementById('overlay');
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const fpsEl = document.getElementById('fps');
  const peopleChip = document.getElementById('peopleChip');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const freezeBtn = document.getElementById('freezeBtn');
  const saveJsonBtn = document.getElementById('saveJsonBtn');
  const shotBtn = document.getElementById('shotBtn');
  const resetBtn = document.getElementById('resetBtn');
  const resLayer = document.getElementById('result');
  const resTitle = document.getElementById('resTitle');
  const resScore = document.getElementById('resScore');
  const resSummary = document.getElementById('resSummary');
  const resTips = document.getElementById('resTips');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');

  // çŠ¶æ€
  let facing='user', stream=null, detector=null;
  let running=false, finalized=false, armed=false;
  let holdStart=null, lastCOM=null, swayEma=0;
  let lastFPS=0, frameCnt=0, lastTS=performance.now();
  let lastPose=null, lastFinal=null;
  let frameIndex=0;

  function fitCanvas(){
    const dpr=1; // ä¸ºé€Ÿåº¦ç¦ç”¨é«˜åˆ†
    const w=canvas.clientWidth||canvas.parentElement.clientWidth;
    const h=canvas.clientHeight||canvas.parentElement.clientHeight;
    canvas.width=Math.round(w*dpr); canvas.height=Math.round(h*dpr);
    ctx.setTransform(1,0,0,1,0,0); ctx.translate(canvas.clientWidth,0); ctx.scale(-1,1);
  }
  new ResizeObserver(fitCanvas).observe(canvas);

  async function startCamera(){
    statusEl.textContent='ğŸ“· è¯·æ±‚æ‘„åƒå¤´â€¦';
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{facingMode:facing, width:CFG.video.width, height:CFG.video.height, frameRate:{ideal:CFG.video.fps,max:CFG.video.fps}}
    });
    video.srcObject=stream; await video.play();
  }

  function pickPrimary(poses){
    if(!poses?.length) return null;
    const center={x:canvas.clientWidth/2, y:canvas.clientHeight/2};
    const scored=poses.map(p=>{
      const xs=p.keypoints.filter(k=>k.score==null||k.score>0.3).map(k=>k.x);
      const ys=p.keypoints.filter(k=>k.score==null||k.score>0.3).map(k=>k.y);
      if(!xs.length||!ys.length) return {p,score:-1};
      const minx=Math.min(...xs), maxx=Math.max(...xs), miny=Math.min(...ys), maxy=Math.max(...ys);
      const area=(maxx-minx)*(maxy-miny); const cx=(minx+maxx)/2, cy=(miny+maxy)/2;
      const d=Math.hypot(cx-center.x, cy-center.y)+1;
      return {p, score: area/d};
    }).sort((a,b)=>b.score-a.score);
    return scored[0].p;
  }

  const dist=(a,b)=> (a&&b)?Math.hypot(a.x-b.x,a.y-b.y):null;
  const angleDeg=(a,b,c)=>{ if(!a||!b||!c) return null; const r=Math.atan2(c.y-b.y,c.x-b.x)-Math.atan2(a.y-b.y,a.x-b.x); let d=Math.abs(r*180/Math.PI); return d>180?360-d:d; };
  const vertness=(a,b)=> (a&&b)? (Math.abs(a.x-b.x)/(Math.abs(a.y-b.y)+1e-6)) : null;
  const ema=((alpha)=>{const mem=new Map(); return (k,v)=>{ if(v==null) return null; const last=mem.get(k); const now=(last==null)?v:alpha*v+(1-alpha)*last; mem.set(k,now); return now; } })(CFG.EMA_ALPHA);

  function drawPoseCtx(g,kps){
    if(!kps?.length) return;
    const edges=[[11,13],[13,15],[12,14],[14,16],[11,12],[23,24],[11,23],[12,24],[23,25],[25,27],[24,26],[26,28],[27,29],[29,31],[28,30],[30,32]];
    g.lineWidth=3; g.strokeStyle='rgba(79,195,247,.9)'; g.fillStyle='#fff';
    g.beginPath();
    for(const [a,b] of edges){ const p=kps[a], q=kps[b]; if(p?.score>.3 && q?.score>.3){ g.moveTo(p.x,p.y); g.lineTo(q.x,q.y); } }
    g.stroke();
    for(const p of kps){ if(p?.score>.3){ g.beginPath(); g.arc(p.x,p.y,4,0,Math.PI*2); g.fill(); } }
  }

  function prayerFallback(kps){
    const ls=kps[11], rs=kps[12], lw=kps[15], rw=kps[16];
    if(!(ls&&rs&&lw&&rw)) return false;
    const chest={x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2};
    const wristsClose=(dist(lw,rw)||9999)<=CFG.PRAYER_WRIST_DIST;
    const wristsNear=(dist(lw,chest)||9999)<=CFG.PRAYER_CHEST_DIST && (dist(rw,chest)||9999)<=CFG.PRAYER_CHEST_DIST;
    return wristsClose && wristsNear;
  }

  function scoreTree(kps){
    const lh=kps[23], rh=kps[24], lk=kps[25], rk=kps[26], la=kps[27], ra=kps[28], ls=kps[11], rs=kps[12], lw=kps[15], rw=kps[16];
    if(!lh||!rh||!lk||!rk||!la||!ra) return {score:0,problems:['å…³é”®ç‚¹ä¸è¶³'],detail:{}};
    const hipMid={x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2};
    const LKA=angleDeg(lh,lk,la), RKA=angleDeg(rh,rk,ra);
    const vL=vertness(lh,la), vR=vertness(rh,ra);
    const leftStandScore=((LKA||0)-CFG.STRAIGHT_MIN)+((CFG.VERT_MAX-(vL||999)));
    const rightStandScore=((RKA||0)-CFG.STRAIGHT_MIN)+((CFG.VERT_MAX-(vR||999)));
    const standLeft = leftStandScore>=rightStandScore;

    const straight = standLeft? LKA:RKA;
    const bent     = standLeft? RKA:LKA;
    const vert     = standLeft? vL :vR;
    const pelvisTilt=Math.abs(lh.y-rh.y);

    // é«‹å¤–å¼€
    const shoulderW=(ls&&rs)? Math.max(40,Math.abs(ls.x-rs.x)):200;
    const liftKnee = standLeft? rk:lk;
    const liftAnkle= standLeft? ra:la;
    const standHip = standLeft? lh:rh;
    const standKnee= standLeft? lk:rk;
    const standAnk = standLeft? la:ra;
    const kneeOut = liftKnee? Math.abs(liftKnee.x - hipMid.x)/shoulderW : 0;

    // æ‰‹ä½ï¼ˆåˆåè¯„åˆ†ï¼‰
    let handsScore=0;
    if(lw&&rw&&ls&&rs){
      const chest={x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2};
      const wristsClose=Math.max(0, Math.min(1, (120-(dist(lw,rw)||999))/120));
      const wristsChest=Math.max(0, Math.min(1, (150-Math.min(dist(lw,chest)||999,dist(rw,chest)||999))/150));
      handsScore = wristsClose*0.6 + wristsChest*0.4;
    }

    // è„šä½é«˜åº¦
    let footScore=0, footRemark='';
    if(liftAnkle&&standHip&&standKnee&&standAnk){
      const top=standHip.y, mid=standKnee.y, bot=standAnk.y, ay=liftAnkle.y;
      if(ay<=top+12){ footScore=CFG.FOOT_BONUS_AT_GROIN; footRemark='è„šè·Ÿæ¥è¿‘å¤§è…¿æ ¹éƒ¨'; }
      else if(ay<mid-6){ footScore=CFG.FOOT_OK_ABOVE_KNEE; footRemark='é«˜äºè†ç›–'; }
      else if(Math.abs(ay-mid)<=12){ footScore=CFG.FOOT_ON_KNEE; footRemark='è„šè¸©åœ¨è†ç›–ï¼ˆé‡æ‰£ï¼‰'; }
      else { footScore=CFG.FOOT_BELOW_KNEE; footRemark='è†ä¸‹æ›´ä½ï¼ˆæ‰£åˆ†ï¼‰'; }
    }

    const swayTh=7;
    const s_stab=Math.max(0, Math.min(1, (swayTh-(swayEma||swayTh))/swayTh));
    const s_straight=Math.max(0, Math.min(1, (straight-CFG.STRAIGHT_MIN)/(180-CFG.STRAIGHT_MIN)));
    const s_bent=Math.max(0, Math.min(1, (CFG.BENT_MAX-bent)/CFG.BENT_MAX));
    const s_vert=Math.max(0, Math.min(1, (CFG.VERT_MAX-vert)/CFG.VERT_MAX));
    const s_hipOpen=Math.max(0, Math.min(1, kneeOut/0.55));
    const s_pelvis=Math.max(0, Math.min(1, (CFG.PELVIS_TILT_MAX-pelvisTilt)/CFG.PELVIS_TILT_MAX));
    const s_hands=handsScore, s_footH=footScore;

    const score=
      s_straight*CFG.W.straight + s_bent*CFG.W.bent + s_hipOpen*CFG.W.hipOpen +
      s_hands*CFG.W.hands + s_footH*CFG.W.footHeight + s_pelvis*CFG.W.pelvis +
      s_stab*CFG.W.stability;

    const problems=[];
    if(s_straight<0.8) problems.push('ç«™ç«‹è…¿éœ€æ›´ç›´');
    if(s_bent<0.8) problems.push('æŠ¬è…¿è†ç›–å†æ”¶ç´§ï¼ˆæ›´å¼¯ï¼‰');
    if(s_hipOpen<0.8) problems.push('é«‹å…³èŠ‚å¤–å¼€ä¸è¶³ï¼ˆè†ç›–å‘å¤–ï¼‰');
    if(s_hands<0.8) problems.push('åŒæ‰‹èƒ¸å‰åˆåï¼ˆé è¿‘èƒ¸ä¸­å¿ƒï¼‰');
    if(footRemark.includes('è†ç›–')) problems.push('é¿å…è„šè¸©åœ¨è†ç›–ï¼ˆæ”¹è´´å¤§è…¿å†…ä¾§ï¼‰');
    if(s_footH<0.8 && !footRemark.includes('è†ç›–')) problems.push('è„šè·Ÿå°½é‡è´´è¿‘å¤§è…¿æ ¹éƒ¨');
    if(s_pelvis<0.8) problems.push('éª¨ç›†ä¿æŒæ°´å¹³');
    if(s_stab<0.8) problems.push('ä¿æŒç¨³å®šï¼Œå‡å°‘æ‘†åŠ¨');

    return { score:Math.round(score), problems, detail:{ standLeft, LKA:Math.round(LKA||0), RKA:Math.round(RKA||0), vert:+(vert||0).toFixed(2), kneeOut:+kneeOut.toFixed(2), footRemark, pelvisTilt:Math.round(pelvisTilt||0)} };
  }

  function finalize(res){
    finalized=true; running=false;
    const s=res.score;
    resTitle.textContent='æ ‘å¼è¯„ä¼°ç»“æœ';
    resScore.textContent=`${s} åˆ†`;
    resScore.className='score '+(s>=85?'ok':(s>=60?'':'bad'));
    resSummary.textContent = s>=85 ? 'å§¿åŠ¿è§„èŒƒï¼Œä¿æŒè‰¯å¥½ï¼' : (s>=60 ? 'åŸºæœ¬è¾¾æ ‡ï¼Œæ³¨æ„ç»†èŠ‚è°ƒæ•´ã€‚' : 'æœªè¾¾æ ‡ï¼Œå»ºè®®æ ¹æ®æç¤ºé€é¡¹çº æ­£ã€‚');
    resTips.innerHTML='';
    (res.problems?.length?res.problems:['æ— æ˜æ˜¾é—®é¢˜ç‚¹']).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; resTips.appendChild(li); });
    lastFinal={ timestamp:new Date().toISOString(), score:s, problems:res.problems, detail:res.detail, config:CFG };
    resLayer.style.display='flex';
  }

  function download(name, blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},800); }
  function saveJSON(){
    const base= lastFinal ?? { timestamp:new Date().toISOString(), ...scoreTree(lastPose?.keypoints||{}), config:CFG };
    download(`tree_pose_${new Date().toISOString().replace(/[:.]/g,'-')}.json`, new Blob([JSON.stringify(base,null,2)],{type:'application/json'}));
  }
  function saveScreenshot(){
    const w=canvas.clientWidth,h=canvas.clientHeight;
    const off=document.createElement('canvas'); off.width=w; off.height=h;
    const g=off.getContext('2d'); g.translate(w,0); g.scale(-1,1);
    try{ g.drawImage(video,0,0,w,h);}catch(e){}
    drawPoseCtx(g, lastPose?.keypoints||[]);
    g.setTransform(1,0,0,1,0,0); g.fillStyle='rgba(0,0,0,.5)'; g.fillRect(10,10,320,26);
    g.fillStyle='#fff'; g.font='14px system-ui,sans-serif'; g.fillText(`Tree Pose Â· ${new Date().toLocaleString()}`,18,29);
    off.toBlob(b=>download(`tree_pose_${new Date().toISOString().replace(/[:.]/g,'-')}.png`,b),'image/png');
  }

  async function loop(){
    if(!running) return;
    try{
      // é™é‡‡æ ·ï¼šéš”å¸§æ¨ç†
      frameIndex++;
      const doInfer = (frameIndex % CFG.sampleEveryN)===0;

      let poses = [];
      if(doInfer){
        poses = await poseDetection.estimatePoses(video, detector, {flipHorizontal:false});
      }
      peopleChip.textContent = `äººæ•°ï¼š${poses?.length||0}`;

      const primary = poses?.length ? pickPrimary(poses) : lastPose; // æ²¡å‡ºç»“æœæ—¶ç”¨ä¸Šä¸€å¸§
      if(primary?.keypoints?.length) lastPose=primary;

      ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
      drawPoseCtx(ctx, lastPose?.keypoints||[]);

      // é«‹ä¸­å¿ƒæ‘†åŠ¨
      const lh=lastPose?.keypoints?.[23], rh=lastPose?.keypoints?.[24];
      const hipMid=(lh&&rh)? {x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2} : null;
      if(hipMid && lastCOM){ const move=dist(hipMid,lastCOM)||0; swayEma = ema('sway', move) ?? move; }
      lastCOM=hipMid;

      // å¯åŠ¨ï¼šåˆå + é™æ­¢
      const still=(swayEma||0) < CFG.STILL_SWAY_TH;
      const canPray = lastPose?.keypoints?.length && prayerFallback(lastPose.keypoints);

      if(!armed){
        hudEl.textContent=`ç­‰å¾…å¯åŠ¨ï¼šç«™å®š+èƒ¸å‰åˆå Â· æ‘†åŠ¨=${(swayEma||0).toFixed(1)}`;
        if(still && canPray){ armed=true; holdStart=performance.now(); statusEl.textContent='âœ… å·²å¯åŠ¨ï¼šä¿æŒä¸åŠ¨ 3 ç§’â€¦'; }
      }else{
        const sec=(performance.now()-(holdStart||performance.now()))/1000;
        hudEl.textContent=`â± å·²å¯åŠ¨ï¼Œä¿æŒä¸åŠ¨â€¦ ${Math.min(CFG.HOLD_SEC,sec).toFixed(1)}/${CFG.HOLD_SEC}s`;
        if(sec>=CFG.HOLD_SEC && lastPose?.keypoints?.length){ finalize( scoreTree(lastPose.keypoints) ); return; }
      }

      // FPS
      frameCnt++; const now=performance.now();
      if(now-lastTS>=1000){ lastFPS=frameCnt; frameCnt=0; lastTS=now; }
      fpsEl.textContent = `FPS:${lastFPS} Â· åˆ†è¾¨ç‡ ${video.videoWidth}Ã—${video.videoHeight}`;
    }catch(e){
      console.error(e); statusEl.textContent='âŒ æ£€æµ‹å¼‚å¸¸'; hudEl.textContent='ç‚¹å‡»â€œé‡æ–°åŠ è½½â€å†è¯•';
    }
    requestAnimationFrame(loop);
  }

  // äº‹ä»¶
  startBtn.addEventListener('click', async ()=>{
    try{
      // å…ˆåŠ è½½è„šæœ¬ï¼Œè¶…æ—¶è¯Šæ–­
      const t0=performance.now();
      const timeout = setTimeout(()=>{ LOG('â±ï¸ è„šæœ¬åŠ è½½è¿‡æ…¢ï¼Œå»ºè®®ï¼šæ”¹HTTPS/æ¢ç½‘ç»œ/ç”¨PCå†…ç½‘IP/æ”¹æœ¬åœ°æ¨¡å‹'); }, 8000);
      await loadScripts(); clearTimeout(timeout);
      LOG(`âœ… è„šæœ¬å°±ç»ªï¼ˆ${Math.round(performance.now()-t0)}msï¼‰`);

      // åˆå§‹åŒ– TFJS + æ¨¡å‹
      await tf.setBackend(CFG.backend); await tf.ready();
      // åˆ›å»º detectorï¼ˆé™æ€å¼•ç”¨æ–¹å¼æ›´å¿«ï¼‰
      window.poseDetection = window.poseDetection || await (async()=>window.poseDetection)();
      const model = poseDetection.SupportedModels.BlazePose;
      detector = await poseDetection.createDetector(model, { runtime:'tfjs', modelType:CFG.poseModelType, enableSmoothing:CFG.smoothing });

      // æ‘„åƒå¤´
      await startCamera(); overlay.style.display='none'; fitCanvas();

      running=true; finalized=false; armed=false; holdStart=null; swayEma=0; lastFinal=null;
      statusEl.textContent='âœ… æ¨¡å‹å°±ç»ªï¼šç«™å®šå¹¶èƒ¸å‰åˆåä»¥å¼€å§‹';
      loop();
    }catch(e){
      console.error(e);
      statusEl.textContent='âŒ å¯åŠ¨å¤±è´¥ï¼ˆç½‘ç»œ/æƒé™/HTTPSï¼‰'; LOG(String(e));
    }
  });

  switchBtn.addEventListener('click', async ()=>{ facing=(facing==='user')?'environment':'user'; try{ await startCamera(); }catch(e){ LOG(String(e)); } });
  resetBtn.addEventListener('click', ()=> location.reload());
  freezeBtn.addEventListener('click', ()=>{ if(finalized) return; if(!lastPose?.keypoints?.length){ statusEl.textContent='å°šæœªæ£€æµ‹åˆ°äººä½“'; return; } finalize( scoreTree(lastPose.keypoints) ); });
  saveJsonBtn.addEventListener('click', saveJSON);
  shotBtn.addEventListener('click', ()=>{
    const w=canvas.clientWidth,h=canvas.clientHeight;
    const off=document.createElement('canvas'); off.width=w; off.height=h;
    const g=off.getContext('2d'); g.translate(w,0); g.scale(-1,1);
    try{ g.drawImage(video,0,0,w,h);}catch(e){}
    drawPoseCtx(g, lastPose?.keypoints||[]);
    g.setTransform(1,0,0,1,0,0); g.fillStyle='rgba(0,0,0,.5)'; g.fillRect(10,10,320,26);
    g.fillStyle='#fff'; g.font='14px system-ui,sans-serif'; g.fillText(`Tree Pose Â· ${new Date().toLocaleString()}`,18,29);
    off.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`tree_pose_${new Date().toISOString().replace(/[:.]/g,'-')}.png`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800); },'image/png');
  });
  retryBtn.addEventListener('click', ()=>{ resLayer.style.display='none'; finalized=false; armed=false; holdStart=null; swayEma=0; lastFinal=null; running=true; loop(); });
  closeBtn.addEventListener('click', ()=>{ resLayer.style.display='none'; });

  if(!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    statusEl.textContent='âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´'; startBtn.disabled=true;
  }
})();
</script>
</body>
</html>
