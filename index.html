<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>æ ‘å¼è¯„ä¼° Â· è‡ªåŠ¨è¯„åˆ†ï¼ˆæ–°ç‰ˆæ ‡å‡†ï¼‰</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body, html { height: 100%; background: #000; color: white; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
#video, #canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
#status { position: absolute; top: 12px; width: 100%; text-align: center; color: #4fc3f7; font-size: 14px; text-shadow: 0 1px 3px rgba(0,0,0,0.6); }
#hud { position: absolute; top: 40px; width: 100%; text-align: center; font-size: 18px; font-weight: bold; }
#overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); z-index: 10; }
button { background: #4fc3f7; color: white; border: none; padding: 14px 28px; border-radius: 12px; font-size: 16px; margin-top: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(79,195,247,0.2); }
.btn-ghost { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); }
#result { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 20; }
.card { background: rgba(30,30,35,0.95); padding: 20px; border-radius: 16px; text-align: center; max-width: 90%; width: 300px; }
.score { font-size: 40px; margin: 10px 0; }
</style>
</head>

<body>
<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="status">â³ æ­£åœ¨åˆå§‹åŒ–â€¦</div>
<div id="hud"></div>
<div id="overlay">
  <div style="font-size:22px;">ğŸ§˜ æ ‘å¼è¯„ä¼° Â· è‡ªåŠ¨è¯„åˆ†</div>
  <div style="margin-top:8px; font-size:14px; color:#bbb;">
    è¯·ç«™å®šï¼ŒåŒæ‰‹åˆåäºèƒ¸å‰ã€‚<br> ä¿æŒå§¿åŠ¿ <b>5ç§’</b> è‡ªåŠ¨è¯„åˆ†ã€‚
  </div>
  <button id="startBtn">ğŸ‘‰ å¼€å¯æ‘„åƒå¤´</button>
</div>

<div id="result">
  <div class="card">
    <div>æ ‘å¼è¯„ä¼°ç»“æœ</div>
    <div class="score" id="scoreEl">--</div>
    <div id="summaryEl"></div>
    <button id="againBtn" style="margin-top:16px; width:100%">å†æµ‹ä¸€æ¬¡</button>
  </div>
</div>

<script>
(async () => {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const startBtn = document.getElementById('startBtn');
  const resultDiv = document.getElementById('result');
  const scoreEl = document.getElementById('scoreEl');
  const summaryEl = document.getElementById('summaryEl');
  const againBtn = document.getElementById('againBtn');
  let detector = null;
  let running = false;
  let holdStart = null;
  let lastKeypoints = null;

  // å¯åŠ¨æ‘„åƒå¤´
  async function startCamera() {
    try {
      statusEl.textContent = 'ğŸ“· è¯·æ±‚æ‘„åƒå¤´â€¦';
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
        audio: false
      });
      video.srcObject = stream;
      video.onloadedmetadata = () => {
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        statusEl.textContent = 'ğŸ§  åŠ è½½AIæ¨¡å‹â€¦';
        loadModel();
      };
      video.play().catch(err => { console.warn('play() è¢«é˜»æ­¢'); });
    } catch (err) {
      console.error('æ‘„åƒå¤´å¤±è´¥:', err);
      statusEl.textContent = 'âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥';
      alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
    }
  }

  // åŠ è½½æ¨¡å‹
  async function loadModel() {
    try {
      await tf.setBackend('webgl');
      await tf.ready();
      detector = await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose, {
        runtime: 'tfjs', modelType: 'full', enableSmoothing: true, enableTracking: true
      });
      document.getElementById('overlay').style.display = 'none';
      running = true;
      statusEl.textContent = 'å‡†å¤‡å°±ç»ª';
      detectLoop();
    } catch (err) {
      console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', err);
      statusEl.textContent = 'âŒ AIæ¨¡å‹åŠ è½½å¤±è´¥';
      alert('AIæ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
    }
  }

  // è¾…åŠ©å‡½æ•°
  const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
  const angle=(a,b,c)=>{
    if(!a||!b||!c)return null;
    const ab=Math.hypot(a.x-b.x,a.y-b.y);
    const bc=Math.hypot(b.x-c.x,b.y-c.y);
    const ac=Math.hypot(a.x-c.x,a.y-c.y);
    if(ab===0||bc===0)return null;
    const cosB=(ab*ab+bc*bc-ac*ac)/(2*ab*bc);
    return Math.acos(Math.max(-1,Math.min(1,cosB)))*180/Math.PI;
  };
  function getKP(kps,i,conf=0.3){const kp=kps[i];return (kp&&kp.score>=conf)?kp:null;}
  function inFrame(kps,w=canvas.width,h=canvas.height){
    const need=[0,23,24,27,28];
    for(const idx of need){const p=getKP(kps,idx);if(!p||p.x<0||p.y<0||p.x>w||p.y>h)return false;}
    return true;
  }
  function pointSegDist(p,a,b){if(!p||!a||!b)return Infinity;const vx=b.x-a.x,vy=b.y-a.y;const wx=p.x-a.x,wy=p.y-a.y;
    const c1=vx*wx+vy*wy;const c2=vx*vx+vy*vy||1e-6;let t=c1/c2;t=Math.max(0,Math.min(1,t));
    const px=a.x+t*vx,py=a.y+t*vy;return Math.hypot(p.x-px,p.y-py);}
  function kneeAngleLeftRight(kps){return{L:angle(getKP(kps,23),getKP(kps,25),getKP(kps,27)),R:angle(getKP(kps,24),getKP(kps,26),getKP(kps,28))};}
  function wristDistance(kps){const lw=getKP(kps,15),rw=getKP(kps,16);return(lw&&rw)?Math.hypot(lw.x-rw.x,lw.y-rw.y):Infinity;}

  // ç»˜åˆ¶å…³é”®ç‚¹
  function drawPoints(kps){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle='red';
    for(const kp of kps){if(kp.score>0.3){ctx.beginPath();ctx.arc(kp.x,kp.y,4,0,Math.PI*2);ctx.fill();}}
  }

  // === æ–°ç‰ˆ å››ç»´åº¦è¯„åˆ† evaluate(kps) ===
  function evaluate(kps){
    const {L:LKA,R:RKA}=kneeAngleLeftRight(kps);
    if(LKA==null||RKA==null)return{score:0,msg:'å…³é”®ç‚¹ä¸è¶³'};
    const lank=getKP(kps,27),rank=getKP(kps,28);
    let support=(LKA>=RKA)?'L':'R';
    if(LKA>=165&&RKA>=165&&lank&&rank){support=(lank.y>rank.y)?'L':'R';}
    const supKnee=(support==='L')?getKP(kps,25):getKP(kps,26);
    const supAnk=(support==='L')?lank:rank;
    const supHip=(support==='L')?getKP(kps,23):getKP(kps,24);
    const supAngle=(support==='L')?LKA:RKA;

    let s_support=0;
    if(supAngle>=170)s_support=10;
    else if(supAngle>=160)s_support=8+(supAngle-160)/10*2;
    else if(supAngle>=150)s_support=6+(supAngle-150)/10*2;
    else s_support=Math.max(0,(supAngle-120)/30*6);
    if(lastKeypoints&&supAnk){
      const prev=(support==='L')?lastKeypoints[27]:lastKeypoints[28];
      if(prev&&prev.score>=0.3){
        const drift=Math.hypot(supAnk.x-prev.x,supAnk.y-prev.y);
        if(drift>6){
          const pen=Math.min(4,(drift-6)/9*2+Math.max(0,drift-15)/10*2);
          s_support=Math.max(0,s_support-pen);
        }
      }
    }

    const raise=(support==='L')?'R':'L';
    const rAnk=(raise==='L')?lank:rank;
    const rKnee=(raise==='L')?getKP(kps,25):getKP(kps,26);
    const supKneePt=supKnee,supAnkPt=supAnk;
    let s_raise=0;
    if(rAnk&&rKnee&&supKneePt&&supAnkPt){
      const offGround=(rAnk.y<supAnkPt.y-40);
      const distToCalf=pointSegDist(rAnk,supKneePt,supAnkPt);
      const closeToCalf=distToCalf<50;
      if(offGround&&closeToCalf)s_raise=10;
      else if(offGround||closeToCalf)s_raise=7.5;
      else s_raise=4;
      const hipOpp=(raise==='L')?getKP(kps,24):getKP(kps,23);
      if(rKnee&&hipOpp){
        const bonus=Math.max(0,Math.min(1,(hipOpp.y-rKnee.y)/80));
        s_raise=Math.min(10,s_raise+bonus);
      }
    }else s_raise=0;

    const wd=wristDistance(kps);
    let s_hands=0;
    if(wd<50)s_hands=10;else if(wd<80)s_hands=8;else if(wd<120)s_hands=6;else s_hands=3;

    const now=Date.now();const elapsed=holdStart?(now-holdStart)/1000:0;
    let s_balance=Math.max(0,Math.min(10,(elapsed/5)*10));
    if(!inFrame(kps))s_balance=Math.min(s_balance,5);
    if(lastKeypoints){
      const supPrev=(support==='L')?lastKeypoints[27]:lastKeypoints[28];
      const raisePrev=(raise==='L')?lastKeypoints[27]:lastKeypoints[28];
      const supDrift=(supAnk&&supPrev&&supPrev.score>=0.3)?Math.hypot(supAnk.x-supPrev.x,supAnk.y-supPrev.y):0;
      const raiseDrift=(rAnk&&raisePrev&&raisePrev.score>=0.3)?Math.hypot(rAnk.x-raisePrev.x,rAnk.y-raisePrev.y):0;
      const drift=Math.max(supDrift,raiseDrift);
      if(drift>8){const pen=Math.min(4,(drift-8)/10*4);s_balance=Math.max(0,s_balance-pen);}
    }

    const s0_10=0.3*s_support+0.3*s_raise+0.2*s_hands+0.2*s_balance;
    const total=Math.round(s0_10*10);
    const pass=(s0_10>=6);
    const msg=`æ”¯æ’‘è…¿:${s_support.toFixed(1)} æŠ¬è†è´´åˆ:${s_raise.toFixed(1)} æ‰‹è‡‚:${s_hands.toFixed(1)} å¹³è¡¡å®Œæ•´:${s_balance.toFixed(1)}ï¼ˆ${pass?'åˆæ ¼':'ä¸åˆæ ¼'}ï¼‰`;
    return{score:total,msg};
  }

  // æ£€æµ‹å¾ªç¯
  async function detectLoop(){
    if(!running)return;
    try{
      const poses=await detector.estimatePoses(video);
      if(poses.length===0){
        hudEl.textContent='æœªæ£€æµ‹åˆ°äººä½“';
        holdStart=null;
      }else{
        const kps=poses[0].keypoints;
        drawPoints(kps);
        lastKeypoints=kps;
        const lw=kps[15],rw=kps[16];
        if(lw&&rw&&dist(lw,rw)<60){
          if(!holdStart)holdStart=Date.now();
          const elapsed=(Date.now()-holdStart)/1000;
          if(elapsed>=5){
            const res=evaluate(kps);
            showResult(res.score,res.msg);
            return;
          }
          hudEl.textContent=`âœ… åˆåä¸­ï¼š${Math.ceil(5-elapsed)} ç§’`;
        }else{
          holdStart=null;
          hudEl.textContent='è¯·åŒæ‰‹åˆåäºèƒ¸å‰';
        }
      }
    }catch(err){
      console.error('æ£€æµ‹å‡ºé”™:',err);
      statusEl.textContent='âš ï¸ æ£€æµ‹å¼‚å¸¸';
    }
    requestAnimationFrame(detectLoop);
  }

  function showResult(score,msg){
    scoreEl.textContent=score+' åˆ†';
    summaryEl.textContent=msg||(score>=80?'ä¼˜ç§€ï¼':score>=60?'è‰¯å¥½':'éœ€æ”¹è¿›');
    resultDiv.style.display='flex';
    running=false;
  }

  startBtn.onclick=startCamera;
  againBtn.onclick=()=>{resultDiv.style.display='none';holdStart=null;running=true;detectLoop();};

})();
</script>
</body>
</html>
