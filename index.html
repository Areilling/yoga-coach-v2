<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ğŸ§˜ æ™ºæ…§ä½“è‚²Â·æ ‘å¼è¯„ä¼°ï¼ˆç¨³å®šåè¯„åˆ†ï¼‰</title>
<!-- TFJS & Pose Detection -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:"PingFang SC",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  .stage{position:relative;width:100vw;height:100vh}
  #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #status,#hud,#fps{position:absolute;left:0;width:100%;text-align:center;z-index:10;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  #status{top:12px;color:#4fc3f7;font-size:14px}
  #hud{top:40px;color:#fff;font-size:16px;font-weight:600}
  #fps{top:68px;color:#bbb;font-size:12px}
  #overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.92);z-index:20}
  .title{font-size:22px;line-height:1.5;text-align:center}
  .subtitle{margin-top:8px;font-size:14px;color:#bbb;text-align:center}
  .controls{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:12}
  button{background:#4fc3f7;color:#fff;border:none;padding:10px 14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(79,195,247,.25)}
  button.ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
  .legend{position:absolute;right:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-size:12px;color:#ddd;z-index:11}
  .tips{position:absolute;bottom:8px;width:100%;text-align:center;color:#aaa;font-size:12px}
  /* ç»“æœé¢æ¿ */
  #result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,.65);backdrop-filter: blur(2px)}
  .card{max-width:520px;width:88vw;background:rgba(20,20,22,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
  .card h3{font-size:18px;margin-bottom:8px}
  .score{font-size:40px;font-weight:800;margin:6px 0 12px}
  .ok{color:#2ecc71}.bad{color:#ff6b6b}
  ul{margin:8px 0 0 18px;color:#ddd;font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .row>button{flex:1}
</style>
</head>
<body>
<div class="stage">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status">â³ å°±ç»ªä¸­â€¦</div>
  <div id="hud"></div>
  <div id="fps"></div>

  <div id="overlay">
    <div class="title">ğŸ§˜ æ™ºæ…§ä½“è‚² Â· æ ‘å¼è¯„ä¼°ï¼ˆç¨³å®šåå‡ºåˆ†ï¼‰</div>
    <div class="subtitle">å…‰çº¿å……è¶³ Â· å…¨èº«å…¥é•œï¼ˆå«è„šè¸ï¼‰ Â· å»ºè®®ä½¿ç”¨ HTTPS</div>
    <div style="height:16px"></div>
    <button id="startBtn">ğŸ‘‰ å¼€å¯æ‘„åƒå¤´</button>
    <div class="subtitle" style="margin-top:10px;">è‹¥å¤±è´¥ï¼šæ£€æŸ¥æ‘„åƒå¤´æƒé™/å…³é—­å ç”¨æ‘„åƒå¤´çš„åº”ç”¨</div>
  </div>

  <div class="controls">
    <button id="switchBtn" class="ghost">åˆ‡æ¢å‰/åæ‘„</button>
    <button id="resetBtn" class="ghost">é‡æ–°åŠ è½½</button>
  </div>
  <div class="legend">åˆ¤å®šç»´åº¦ï¼šç›´è…¿ Â· å¼¯è…¿ Â· é«‹è¸å‚ç›´ Â· æŠ¬è„šé«˜åº¦ Â· ç¨³å®šåº¦ Â· éª¨ç›†æ°´å¹³</div>
  <div class="tips">å…¨æœ¬åœ°æ¨ç† Â· ä¸ä¸Šä¼ ä»»ä½•å›¾åƒ/è§†é¢‘</div>

  <!-- ç»“æœå¼¹å±‚ -->
  <div id="result">
    <div class="card">
      <h3 id="resTitle">æ ‘å¼ç»“æœ</h3>
      <div class="score" id="resScore">--</div>
      <div id="resSummary" style="font-size:14px;color:#ccc"></div>
      <ul id="resTips"></ul>
      <div class="row">
        <button id="retryBtn" class="ghost">â†º é‡æ–°æµ‹ä¸€æ¬¡</button>
        <button id="closeBtn">å®Œæˆ</button>
      </div>
    </div>
  </div>
</div>

<script>
(async () => {
  // ====== é…ç½®ï¼ˆå¯æŒ‰éœ€è°ƒå‚ï¼‰======
  const CFG = {
    backend: 'webgl',
    modelType: 'full',
    smoothing: true,
    // æ ‘å¼é˜ˆå€¼
    STRAIGHT_MIN: 160,  // ç«™ç«‹è…¿è†è§’ â‰¥160 è§†ä¸ºâ€œç›´â€
    BENT_MAX: 120,      // æŠ¬è…¿è†è§’ â‰¤120 è§†ä¸ºâ€œå¼¯â€
    VERT_MAX: 0.25,     // é«‹-è¸â€œå‚ç›´åº¦â€ï¼ˆxå·®/ yå·®ï¼‰â‰¤0.25
    FOOT_DELTA_MIN: 18, // æŠ¬è„šè¸ä¸ç«™ç«‹è„šè¸çš„åƒç´ é«˜åº¦å·® â‰¥18 è§†ä¸ºâ€œç¦»åœ°â€
    PELVIS_TILT_MAX: 18,// å·¦å³é«‹ç‚¹çš„yå·®ï¼ˆåƒç´ ï¼‰â‰¤18 è§†ä¸ºâ€œéª¨ç›†è¾ƒæ°´å¹³â€
    HOLD_SEC: 2.0,      // åˆ¤å®šç¨³å®šæŒç»­ç§’æ•°
    EMA_ALPHA: 0.3,     // æŒ‡æ ‡å¹³æ»‘
    // è¯„åˆ†æƒé‡ï¼ˆæ€»è®¡100ï¼‰
    W: { straight:30, bent:20, vertical:20, foot:10, stability:10, pelvis:10 }
  };

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const resetBtn  = document.getElementById('resetBtn');
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const fpsEl = document.getElementById('fps');

  const resultLayer = document.getElementById('result');
  const resTitle = document.getElementById('resTitle');
  const resScore = document.getElementById('resScore');
  const resSummary = document.getElementById('resSummary');
  const resTips = document.getElementById('resTips');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');

  let facing = 'user';
  let stream = null, detector = null;
  let running = false, finalized = false;

  // è‡ªé€‚åº” Canvasï¼ˆå«é•œåƒï¼‰
  function fitCanvas() {
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const w = canvas.clientWidth || canvas.parentElement.clientWidth;
    const h = canvas.clientHeight || canvas.parentElement.clientHeight;
    canvas.width = Math.round(w * dpr);
    canvas.height = Math.round(h * dpr);
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    ctx.translate(canvas.clientWidth, 0);
    ctx.scale(-1, 1);
  }
  new ResizeObserver(fitCanvas).observe(canvas);

  async function startCamera(){
    statusEl.textContent='ğŸ“· è¯·æ±‚æ‘„åƒå¤´â€¦';
    if(stream) stream.getTracks().forEach(t=>t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      audio:false,
      video:{facingMode:facing, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30,max:30}}
    });
    video.srcObject=stream; await video.play();
  }

  async function loadModel(){
    statusEl.textContent='ğŸ§  åŠ è½½æ¨¡å‹â€¦';
    await tf.setBackend(CFG.backend); await tf.ready();
    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime:'tfjs', modelType:CFG.modelType, enableSmoothing:CFG.smoothing }
    );
  }

  const getP = (kps,i,th=.3)=>{
    const kp = kps[i];
    if(!kp) return null;
    const hasScore = typeof kp.score === 'number';
    if(hasScore && kp.score < th) return null;
    return {x:kp.x,y:kp.y,s:hasScore?kp.score:1}
  };
  const angleDeg = (a,b,c)=>{
    if(!a||!b||!c) return null;
    const r = Math.atan2(c.y-b.y,c.x-b.x) - Math.atan2(a.y-b.y,a.x-b.x);
    let d = Math.abs(r*180/Math.PI);
    return d>180 ? 360-d : d;
  };
  const vertness = (a,b)=> (a&&b)? (Math.abs(a.x-b.x)/(Math.abs(a.y-b.y)+1e-6)) : null;
  const dist = (a,b)=> (a&&b)? Math.hypot(a.x-b.x,a.y-b.y):null;

  // æŒ‡æ ‡å¹³æ»‘ä¸ç¨³å®šæ£€æµ‹
  const ema = ((alpha)=>{
    const mem=new Map();
    return (k,v)=>{
      if(v==null) return null;
      const last=mem.get(k);
      const now=(last==null)?v:alpha*v+(1-alpha)*last;
      mem.set(k,now); return now;
    }
  })(CFG.EMA_ALPHA);

  // ç¨³å®šæ€§è®¡æ—¶
  let holdTimer = 0; // æ»¡è¶³æ ‘å¼æ¡ä»¶æ—¶ç´¯ç§¯ï¼Œå•ä½ç§’
  let lastTS = performance.now(), frameCnt=0, lastFPS=0;

  // ç®€å•æ‘†åŠ¨åº¦ï¼šé«‹ä¸­å¿ƒä¸è‚©ä¸­å¿ƒçš„æ¯å¸§ä½ç§»ï¼ˆEMAï¼‰
  let lastCOM=null; // center of mass proxy (hips mid)
  let swayEma = 0;

  function drawPose(kps){
    ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
    if(!kps?.length) return;
    const edges = [
      [11,13],[13,15],[12,14],[14,16],
      [11,12],[23,24],[11,23],[12,24],
      [23,25],[25,27],[24,26],[26,28],
      [27,29],[29,31],[28,30],[30,32]
    ];
    ctx.lineWidth=3; ctx.strokeStyle='rgba(79,195,247,.9)'; ctx.fillStyle='#fff';
    ctx.beginPath();
    for(const [a,b] of edges){
      const p = kps[a], q = kps[b];
      if(p?.score>.3 && q?.score>.3){ ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); }
    }
    ctx.stroke();
    for(const p of kps){
      if(p?.score>.3){ ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); }
    }
  }

  function evalTree(kps){
    const L_HIP=23,R_HIP=24,L_KNEE=25,R_KNEE=26,L_ANK=27,R_ANK=28, L_SH=11,R_SH=12;
    const lh=getP(kps,L_HIP), rh=getP(kps,R_HIP), lk=getP(kps,L_KNEE), rk=getP(kps,R_KNEE), la=getP(kps,L_ANK), ra=getP(kps,R_ANK);
    const ls=getP(kps,L_SH), rs=getP(kps,R_SH);
    if(!lh||!rh||!lk||!rk||!la||!ra) return {ok:false, why:['å…¨èº«å…¥é•œï¼ˆå«é«‹/è†/è¸ï¼‰']};

    // è§’åº¦
    const lkAng = angleDeg(lh,lk,la);
    const rkAng = angleDeg(rh,rk,ra);

    // å‚ç›´åº¦ä¸éª¨ç›†æ°´å¹³
    const vL = vertness(lh,la);
    const vR = vertness(rh,ra);
    const pelvisTilt = Math.abs((lh?.y||0)-(rh?.y||0)); // yå·®è¶Šå°è¶Šæ°´å¹³

    // æŠ¬è„šé«˜åº¦ï¼ˆåƒç´ ï¼‰ï¼šä¸¤è¸ y å·®
    const footDelta = Math.abs(la.y - ra.y);

    // å¹³æ»‘
    const LKA = ema('lkAng', lkAng);
    const RKA = ema('rkAng', rkAng);
    const VL = ema('vL', vL);
    const VR = ema('vR', vR);
    const FD = ema('fd', footDelta);
    const PT = ema('pt', pelvisTilt);

    // åˆ¤æ–­å·¦å³ç«™ç«‹
    const leftStand  = (LKA!=null && RKA!=null && LKA>=CFG.STRAIGHT_MIN && RKA<=CFG.BENT_MAX && VL!=null && VL<=CFG.VERT_MAX);
    const rightStand = (LKA!=null && RKA!=null && RKA>=CFG.STRAIGHT_MIN && LKA<=CFG.BENT_MAX && VR!=null && VR<=CFG.VERT_MAX);
    const ok = leftStand || rightStand;

    // æ‘†åŠ¨åº¦ï¼ˆç¨³å®šæ€§ï¼‰ï¼šé«‹ä¸­å¿ƒç›¸é‚»å¸§ä½ç§»
    const hipMid = (lh&&rh)? {x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2} : null;
    if(hipMid && lastCOM) {
      const move = dist(hipMid,lastCOM)||0;
      swayEma = ema('sway', move) ?? move;
    }
    lastCOM = hipMid;

    // HUD æ•°å€¼
    const hint = `Lè†:${LKA?LKA.toFixed(0):'-'}Â°  Rè†:${RKA?RKA.toFixed(0):'-'}Â° Â· å‚ç›´åº¦:${(leftStand?VL:VR)?.toFixed(2) ?? '-'} Â· æŠ¬è„šÎ”:${FD?FD.toFixed(0):'-'} Â· éª¨ç›†:${PT?PT.toFixed(0):'-'} Â· æ‘†åŠ¨:${swayEma?.toFixed(1) ?? '-'}`;

    // è¯„åˆ†ï¼ˆæŒ‰æœ€æœ‰å¯èƒ½çš„ç«™ç«‹ä¾§ï¼‰
    const standLeft = leftStand ? 'L' : (rightStand ? 'R' : null);
    let score=0, problems=[];
    if(standLeft){ // å·¦ç«™å³æŠ¬ or å³ç«™å·¦æŠ¬
      const straight = (standLeft==='L') ? LKA : RKA;
      const bent     = (standLeft==='L') ? RKA : LKA;
      const vert     = (standLeft==='L') ? VL  : VR;
      const footOK   = FD!=null && FD>=CFG.FOOT_DELTA_MIN;

      // å„ç»´å¾—åˆ†ï¼ˆçº¿æ€§æ‰£åˆ†ï¼Œä¿åº•0ï¼‰
      const s_straight = Math.max(0, Math.min(1, (straight - CFG.STRAIGHT_MIN) / (180 - CFG.STRAIGHT_MIN)));
      const s_bent     = Math.max(0, Math.min(1, (CFG.BENT_MAX - bent) / CFG.BENT_MAX));
      const s_vert     = Math.max(0, Math.min(1, (CFG.VERT_MAX - vert) / CFG.VERT_MAX));
      const s_foot     = footOK ? 1 : Math.max(0, Math.min(1, FD/CFG.FOOT_DELTA_MIN));
      const s_pelvis   = Math.max(0, Math.min(1, (CFG.PELVIS_TILT_MAX - (PT||999)) / CFG.PELVIS_TILT_MAX));
      // ç¨³å®šåº¦ï¼ˆæ‘†åŠ¨è¶Šå°è¶Šå¥½ï¼›é˜ˆå€¼ç»éªŒ 6pxï¼‰
      const swayTh = 6;
      const s_stab = Math.max(0, Math.min(1, (swayTh - (swayEma||swayTh)) / swayTh));

      score =
        s_straight*CFG.W.straight +
        s_bent*CFG.W.bent +
        s_vert*CFG.W.vertical +
        s_foot*CFG.W.foot +
        s_stab*CFG.W.stability +
        s_pelvis*CFG.W.pelvis;

      // è®°å½•é—®é¢˜ç‚¹
      if(s_straight < 0.8) problems.push('ç«™ç«‹è…¿éœ€æ›´ç›´');
      if(s_bent < 0.8) problems.push('æŠ¬èµ·è…¿éœ€æ›´å¼¯æ›²');
      if(s_vert < 0.8) problems.push('ç«™ç«‹è…¿ä¿æŒæ›´å‚ç›´ï¼ˆé«‹-è¸ï¼‰');
      if(!footOK) problems.push('æŠ¬èµ·è„šè¸æ›´é«˜ï¼ˆæ˜æ˜¾ç¦»åœ°ï¼‰');
      if(s_pelvis < 0.8) problems.push('éª¨ç›†ä¿æŒæ°´å¹³ï¼ˆä¸¤é«‹ç­‰é«˜ï¼‰');
      if(s_stab < 0.8) problems.push('ä¿æŒç¨³å®šï¼ˆä¸Šèº«å‡å°‘æ‘†åŠ¨ï¼‰');
    }

    return { ok, leftStand, rightStand, hint, score:Math.round(score), problems };
  }

  // çŠ¶æ€æœºï¼šè·Ÿè¸ª â†’ æŒç¨³ â†’ ç»“ç®—
  function finalizeAndShow(res){
    finalized = true; running = false;
    resTitle.textContent = 'æ ‘å¼è¯„ä¼°ç»“æœ';
    resScore.textContent = `${res.score} åˆ†`;
    resScore.className = 'score ' + (res.score>=85?'ok':(res.score>=60?'':'bad'));
    resSummary.textContent = res.score>=85 ? 'å§¿åŠ¿è§„èŒƒï¼Œä¿æŒè‰¯å¥½ï¼' : (res.score>=60 ? 'åŸºæœ¬è¾¾æ ‡ï¼Œæ³¨æ„ç»†èŠ‚è°ƒæ•´ã€‚' : 'æœªè¾¾æ ‡ï¼Œå»ºè®®æ ¹æ®æç¤ºé€é¡¹çº æ­£ã€‚');
    resTips.innerHTML = '';
    if(res.problems?.length){
      res.problems.forEach(t=>{
        const li=document.createElement('li'); li.textContent=t; resTips.appendChild(li);
      });
    } else {
      const li=document.createElement('li'); li.textContent='æ— æ˜æ˜¾é—®é¢˜ç‚¹ã€‚';
      resTips.appendChild(li);
    }
    resultLayer.style.display='flex';
  }

  let rafId=null;
  async function loop(){
    if(!running) return;
    try{
      const poses = await detector.estimatePoses(video,{flipHorizontal:false});
      const pose = poses?.[0];
      if(!pose?.keypoints?.length){
        hudEl.textContent='æœªæ£€æµ‹åˆ°äººä½“ï¼šè¯·ä¿æŒå…¨èº«å…¥é•œ';
        drawPose([]);
      }else{
        drawPose(pose.keypoints);
        const res = evalTree(pose.keypoints);
        hudEl.textContent = (res.ok?'âœ… è¿›å…¥æ ‘å¼åˆ¤å®š Â· ':'è¯·è¿›å…¥æ ‘å¼ï¼ˆå•è…¿ç«™ç«‹ï¼‰ Â· ') + res.hint;

        // è®¡ç®—FPS
        frameCnt++; const now = performance.now();
        if(now - lastTS >= 1000){ lastFPS=frameCnt; frameCnt=0; lastTS=now; }
        fpsEl.textContent = `FPS:${lastFPS} Â· åˆ†è¾¨ç‡ ${video.videoWidth}Ã—${video.videoHeight}`;

        // æŒç¨³è®¡æ—¶/ç»“ç®—
        const dt = 1/(lastFPS||30);
        if(res.ok) holdTimer += dt; else holdTimer = Math.max(0, holdTimer - dt*0.5); // ç¦»å¼€åˆ¤å®šåˆ™å›é€€ä¸€ç‚¹
        statusEl.textContent = res.ok ? `â± ç¨³å®šä¸­â€¦ ${Math.min(CFG.HOLD_SEC, holdTimer).toFixed(1)}/${CFG.HOLD_SEC}s`
                                      : 'æç¤ºï¼šå•è…¿å¹³è¡¡ã€ç«™ç«‹è…¿ç›´ã€æŠ¬è…¿å¼¯ã€é«‹è¸å‚ç›´';
        if(!finalized && holdTimer >= CFG.HOLD_SEC){
          finalizeAndShow(res);
          return; // åœæ­¢å¾ªç¯
        }
      }
    }catch(e){
      console.error(e);
      statusEl.textContent='âŒ æ£€æµ‹å¼‚å¸¸'; hudEl.textContent='ç‚¹å‡»â€œé‡æ–°åŠ è½½â€å†è¯•';
    }
    rafId = requestAnimationFrame(loop);
  }

  // äº‹ä»¶
  startBtn.addEventListener('click', async ()=>{
    try{
      await startCamera(); overlay.style.display='none'; fitCanvas();
      await loadModel();
      running=true; finalized=false; holdTimer=0; statusEl.textContent='âœ… æ¨¡å‹å°±ç»ªï¼Œè¿›å…¥æ ‘å¼â€¦';
      loop();
    }catch(e){
      console.error(e);
      statusEl.textContent='âŒ å¯åŠ¨å¤±è´¥'; overlay.style.display='';
    }
  });
  switchBtn.addEventListener('click', async ()=>{
    facing = (facing==='user') ? 'environment' : 'user';
    try{ await startCamera(); }catch(e){ console.error(e); }
  });
  resetBtn.addEventListener('click', ()=> location.reload());
  retryBtn.addEventListener('click', ()=>{
    resultLayer.style.display='none';
    finalized=false; holdTimer=0; running=true; loop();
  });
  closeBtn.addEventListener('click', ()=> { resultLayer.style.display='none'; });

  // å…¼å®¹æ€§æç¤º
  if(!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
    statusEl.textContent='âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´'; startBtn.disabled=true;
  }
})();
</script>
</body>
</html>
