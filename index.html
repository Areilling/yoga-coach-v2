<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ğŸ§˜ æ ‘å¼è¯„ä¼° Â· 10ç§’è‡ªåŠ¨è¯„åˆ†</title>
<!-- ä¾èµ–ï¼šTFJS + pose-detectionï¼ˆBlazePoseï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;overflow:hidden}
  #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #status{position:absolute;top:12px;left:0;width:100%;text-align:center;color:#4fc3f7;font-size:14px;text-shadow:0 2px 8px rgba(0,0,0,.5)}
  #hud{position:absolute;top:42px;left:0;width:100%;text-align:center;font-size:16px;font-weight:700}
  #overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.92);z-index:10}
  .title{font-size:22px}
  .sub{margin-top:8px;font-size:14px;color:#bbb;text-align:center}
  button{background:#4fc3f7;color:#fff;border:none;padding:12px 20px;border-radius:12px;font-weight:700;font-size:15px;cursor:pointer;box-shadow:0 10px 24px rgba(79,195,247,.25);margin-top:16px}
  .ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
  #result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);z-index:20;backdrop-filter:blur(2px)}
  .card{width:min(92vw,520px);background:rgba(22,22,26,.96);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
  .card h3{margin:0 0 8px 0}
  .score{font-size:44px;font-weight:900;margin:4px 0 10px}
  .ok{color:#2ecc71}.bad{color:#ff6b6b}
  ul{margin:10px 0 0 18px;font-size:14px;color:#ddd}
  .row{display:flex;gap:10px;margin-top:14px}
  .row>button{flex:1}
  .chip{position:absolute;left:12px;bottom:16px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px}
</style>
</head>
<body>
<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>
<div id="status">â³ åˆå§‹åŒ–â€¦</div>
<div id="hud"></div>

<div id="overlay">
  <div class="title">ğŸ§˜ æ ‘å¼è¯„ä¼° Â· 10ç§’è‡ªåŠ¨è¯„åˆ†</div>
  <div class="sub">ç«™å®šå <b>èƒ¸å‰åˆå</b> â†’ ä¿æŒ <b>10ç§’</b> è‡ªåŠ¨å‡ºåˆ†ï¼ˆä¸éœ€è¦ç‚¹ä»»ä½•æŒ‰é’®ï¼‰ã€‚</div>
  <button id="startBtn">ğŸ‘‰ å¼€å¯æ‘„åƒå¤´</button>
  <div class="sub">æ¸©é¦¨æç¤ºï¼šå°½é‡å…¨èº«å…¥é•œï¼Œå…‰çº¿å……è¶³ï¼Œè„šè¸ä¸è¦å‡ºç”»ã€‚</div>
</div>

<div id="result">
  <div class="card">
    <h3>æ ‘å¼è¯„ä¼°ç»“æœï¼ˆåˆæ ¼çº¿ï¼š60ï¼‰</h3>
    <div class="score" id="scoreEl">--</div>
    <div id="summaryEl" style="color:#ccc;font-size:14px"></div>
    <ul id="tipsEl"></ul>
    <div class="row">
      <button id="retryBtn" class="ghost">â†º é‡æ–°æµ‹ä¸€æ¬¡</button>
      <button id="closeBtn">å®Œæˆ</button>
    </div>
  </div>
</div>

<div class="chip" id="stateChip">ç­‰å¾…å¼€å§‹</div>

<script>
(async () => {
  // ========= é…ç½® =========
  const CFG = {
    backend: 'webgl',
    modelType: 'lite',       // é€Ÿåº¦ä¼˜å…ˆ
    width: 640, height: 480, fps: 24,
    holdSeconds: 10,         // å¿…é¡»â‰¥10ç§’
    stillSwayTh: 5,          // é«‹å¿ƒæ‘†åŠ¨é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    maxFootMove: 12,         // æ”¯æ’‘è„šä½ç§»é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
    prayerWristMax: 70,      // ä¸¤è…•è·ç¦»ï¼ˆåˆåï¼‰
    prayerChestMax: 140,     // è…•-èƒ¸ä¸­å¿ƒè·ç¦»
    straightMin: 165,        // æ”¯æ’‘è†è§’
    bentMax: 120,            // æŠ¬è…¿è†è§’
    shinHitDist: 40,         // æŠ¬è„šè¸åˆ°æ”¯æ’‘èƒ«éª¨çš„è·ç¦»ï¼ˆâ€œè´´å°è…¿â€ï¼‰
  };

  // ========= DOM =========
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha:true });
  const overlay = document.getElementById('overlay');
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const stateChip = document.getElementById('stateChip');
  const startBtn = document.getElementById('startBtn');
  const resLayer = document.getElementById('result');
  const scoreEl = document.getElementById('scoreEl');
  const summaryEl = document.getElementById('summaryEl');
  const tipsEl = document.getElementById('tipsEl');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');

  // ========= çŠ¶æ€ =========
  let detector=null, running=false, armed=false, finalized=false;
  let holdStart=null, lastPose=null;
  let hipPrev=null, swayEma=0;
  let standFootStart=null; // æ”¯æ’‘è„šåˆå§‹ä½ç½®
  let standLeft=true;      // å“ªæ¡è…¿ä¸ºæ”¯æ’‘è…¿

  // ========= å·¥å…· =========
  const dist = (a,b)=> (a&&b)?Math.hypot(a.x-b.x,a.y-b.y):Infinity;
  const angle = (a,b,c)=>{ if(!a||!b||!c) return null;
    const ab=Math.hypot(a.x-b.x,a.y-b.y), bc=Math.hypot(b.x-c.x,b.y-c.y), ac=Math.hypot(a.x-c.x,a.y-c.y);
    if(!ab||!bc) return null;
    const cos=(ab*ab+bc*bc-ac*ac)/(2*ab*bc);
    const rad=Math.acos(Math.max(-1,Math.min(1,cos)));
    let deg=rad*180/Math.PI; if(deg>180) deg=360-deg; return deg;
  };
  const emaGen=a=>{let v=null;return x=>(v==null? (v=x) : v=a*x+(1-a)*v, v)}; const ema=emaGen(0.3);

  function drawPose(kps){
    if(!kps?.length) return;
    const edges=[[11,13],[13,15],[12,14],[14,16],[11,12],[23,24],[11,23],[12,24],[23,25],[25,27],[24,26],[26,28]];
    ctx.lineWidth=3; ctx.strokeStyle='rgba(79,195,247,.9)'; ctx.fillStyle='#fff';
    ctx.beginPath();
    for(const [a,b] of edges){ const p=kps[a],q=kps[b]; if(p?.score>.3&&q?.score>.3){ ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); } }
    ctx.stroke();
    for(const p of kps){ if(p?.score>.3){ ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); } }
  }

  function fullBodyIn(kps){
    const head = kps[0] || kps[3] || kps[4];
    const ankL = kps[27], ankR = kps[28];
    return (head?.score>0.2) && (ankL?.score>0.2) && (ankR?.score>0.2);
  }

  function isPrayer(kps){
    const ls=kps[11], rs=kps[12], lw=kps[15], rw=kps[16];
    if(!(ls&&rs&&lw&&rw)) return false;
    const chest={x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2};
    return dist(lw,rw)<=CFG.prayerWristMax &&
           dist(lw,chest)<=CFG.prayerChestMax &&
           dist(rw,chest)<=CFG.prayerChestMax;
  }

  function selectStandLeg(kps){
    const lh=kps[23], rh=kps[24], lk=kps[25], rk=kps[26], la=kps[27], ra=kps[28];
    const LKA=angle(lh,lk,la), RKA=angle(rh,rk,ra);
    // è°æ›´ç›´/æ›´å‚ç›´å°±å½“æ”¯æ’‘è…¿
    const vL=Math.abs(lh.x-la.x)/(Math.abs(lh.y-la.y)+1e-6);
    const vR=Math.abs(rh.x-ra.x)/(Math.abs(rh.y-ra.y)+1e-6);
    const leftScore=(LKA||0)-(vL*50), rightScore=(RKA||0)-(vR*50);
    return (leftScore>=rightScore);
  }

  function pointLineDist(p,a,b){ if(!p||!a||!b) return Infinity;
    const A=p.x-a.x, B=p.y-a.y, C=b.x-a.x, D=b.y-a.y;
    const dot=A*C+B*D, len=C*C+D*D; const t=Math.max(0,Math.min(1,dot/(len||1)));
    const x=a.x + t*C, y=a.y + t*D; return Math.hypot(p.x-x,p.y-y);
  }

  // ========= ç»´åº¦è¯„åˆ†ï¼ˆ0~10ï¼‰ =========
  function scoreSupportLeg(kps, standLeft, stillOK, footMovePx){
    const h=standLeft? kps[23]:kps[24];
    const k=standLeft? kps[25]:kps[26];
    const a=standLeft? kps[27]:kps[28];
    const kneeAngle=angle(h,k,a)||0;
    const straightScore = Math.max(0, Math.min(10, (kneeAngle - CFG.straightMin) / (180-CFG.straightMin) * 10));
    const stableScore = stillOK && footMovePx<=CFG.maxFootMove ? 10 : Math.max(0, 10 - (footMovePx-CFG.maxFootMove)*0.5);
    return Math.round((straightScore*0.6 + stableScore*0.4)*10)/10;
  }

  function scoreLiftAndAttach(kps, standLeft){
    const hipS=standLeft? kps[23]:kps[24];
    const kneeS=standLeft? kps[25]:kps[26];
    const ankS =standLeft? kps[27]:kps[28];
    const hipL=!standLeft? kps[23]:kps[24];
    const kneeL=!standLeft? kps[25]:kps[26];
    const ankL =!standLeft? kps[27]:kps[28];
    if(!(hipS&&kneeS&&ankS&&hipL&&kneeL&&ankL)) return 0;

    const bend = angle(hipL,kneeL,ankL)||180;
    const bendScore = Math.max(0, Math.min(10, (CFG.bentMax - bend) / CFG.bentMax * 10)); // è¶Šå°è¶Šå¥½

    // â€œè´´å°è…¿â€ï¼šæŠ¬è„šè¸åˆ°æ”¯æ’‘èƒ«éª¨ç›´çº¿çš„è·ç¦»å°ï¼Œä¸” y ä»‹äºæ”¯æ’‘è†å’Œè¸ä¹‹é—´
    const dToShin = pointLineDist(ankL, kneeS, ankS);
    const between = (ankL.y >= Math.min(kneeS.y, ankS.y)-12) && (ankL.y <= Math.max(kneeS.y, ankS.y)+12);
    const notGround = Math.abs(ankL.y - ankS.y) < (Math.abs(kneeS.y - ankS.y)*1.1); // ä¸ä½äºåœ°é¢å¤ªå¤š
    let attachScore = 0;
    if(between && notGround){
      attachScore = Math.max(0, Math.min(10, (CFG.shinHitDist - dToShin) / CFG.shinHitDist * 10));
    }
    // ç»¼åˆï¼šå¼¯è† 60%ï¼Œè´´åˆ 40%
    return Math.round((bendScore*0.6 + attachScore*0.4)*10)/10;
  }

  function scoreHands(kps){
    const ls=kps[11], rs=kps[12], lw=kps[15], rw=kps[16];
    if(!(ls&&rs&&lw&&rw)) return 0;
    const chest={x:(ls.x+rs.x)/2, y:(ls.y+rs.y)/2};
    const wristsClose = Math.max(0, Math.min(1, (CFG.prayerWristMax - dist(lw,rw)) / CFG.prayerWristMax));
    const wristsNearC = Math.max(0, Math.min(1, (CFG.prayerChestMax - Math.min(dist(lw,chest),dist(rw,chest))) / CFG.prayerChestMax));
    return Math.round((wristsClose*0.6 + wristsNearC*0.4)*10*10)/10; // 0~10
  }

  function scoreBalanceCompleteness(kps, holdSec, footMovePx){
    if(!fullBodyIn(kps)) return 0;
    const holdScore = Math.max(0, Math.min(10, holdSec/CFG.holdSeconds*10));
    const footStable = footMovePx<=CFG.maxFootMove ? 10 : Math.max(0, 10-(footMovePx-CFG.maxFootMove)*0.5);
    return Math.round((holdScore*0.7 + footStable*0.3)*10)/10;
  }

  // ========= æ‰“åˆ†æ±‡æ€»ï¼ˆç™¾åˆ†åˆ¶ï¼‰ =========
  function summarizeScores(support, liftAttach, hands, balance){
    const total10 = support*0.30 + liftAttach*0.30 + hands*0.20 + balance*0.20; // 0~10
    return Math.round(total10*10); // ç™¾åˆ†åˆ¶
  }

  // ========= ä¸»å¾ªç¯ =========
  async function loop(){
    if(!running || finalized) return;
    try{
      const poses = await detector.estimatePoses(video, {flipHorizontal:false});
      const pose = poses?.[0]; // å•äºº
      ctx.clearRect(0,0,canvas.width,canvas.height);

      if(!pose?.keypoints?.length){
        hudEl.textContent='æœªæ£€æµ‹åˆ°äººä½“';
        holdStart=null; armed=false; standFootStart=null; hipPrev=null; swayEma=0;
        requestAnimationFrame(loop); return;
      }
      const kps = pose.keypoints;
      lastPose = pose;
      drawPose(kps);

      // é€‰æ‹©æ”¯æ’‘è…¿
      standLeft = selectStandLeg(kps);

      // é«‹å¿ƒä¸æ‘†åŠ¨
      const lh=kps[23], rh=kps[24];
      const hipMid = (lh&&rh)? {x:(lh.x+rh.x)/2, y:(lh.y+rh.y)/2} : null;
      if(hipMid && hipPrev){ const move=Math.hypot(hipMid.x-hipPrev.x, hipMid.y-hipPrev.y); swayEma = ema(move); }
      hipPrev=hipMid;
      const stillOK = (swayEma||0) < CFG.stillSwayTh;

      // æ”¯æ’‘è„šä½ç§»
      const standAnk = standLeft? kps[27]:kps[28];
      if(!standFootStart && standAnk) standFootStart = {x:standAnk.x, y:standAnk.y};
      const footMovePx = standAnk && standFootStart ? Math.hypot(standAnk.x-standFootStart.x, standAnk.y-standFootStart.y) : 0;

      // å¯åŠ¨æ¡ä»¶ï¼šåˆå + å…¨èº«å…¥é•œ + åŸºæœ¬é™æ­¢
      if(!armed){
        stateChip.textContent = 'ç­‰å¾…ï¼šç«™å®šå¹¶èƒ¸å‰åˆå';
        if(isPrayer(kps) && fullBodyIn(kps) && stillOK){
          armed=true; holdStart=performance.now(); stateChip.textContent='å·²å¯åŠ¨ï¼šä¿æŒ 10 ç§’â€¦';
        }
      }else{
        const holdSec = (performance.now() - holdStart)/1000;
        hudEl.textContent = `â± æ­£åœ¨è®¡æ—¶ï¼š${Math.min(CFG.holdSeconds, holdSec).toFixed(1)} / ${CFG.holdSeconds}s`;
        stateChip.textContent = 'ä¿æŒä¸åŠ¨â€¦å¦‚ä¸­æ–­å°†é‡æ–°è®¡æ—¶';
        // è‹¥ä¸­æ–­ï¼šåˆåæ¶ˆå¤±/å¤§å¹…ç§»åŠ¨/äººå‡ºæ¡† â†’ é‡æ–°è®¡æ—¶
        if(!isPrayer(kps) || !fullBodyIn(kps) || !stillOK){
          armed=false; holdStart=null; standFootStart=null; stateChip.textContent='è®¡æ—¶ä¸­æ–­ï¼Œé‡æ–°ç«™å®šåˆå';
        }else if(holdSec>=CFG.holdSeconds){
          // é€ç»´æ‰“åˆ†
          const s1 = scoreSupportLeg(kps, standLeft, stillOK, footMovePx);
          const s2 = scoreLiftAndAttach(kps, standLeft);
          const s3 = scoreHands(kps);
          const s4 = scoreBalanceCompleteness(kps, holdSec, footMovePx);
          const total = summarizeScores(s1,s2,s3,s4);

          // ä¸“ä¸šæç¤º
          const tips=[];
          if(s1<8) tips.push('æ”¯æ’‘è…¿ï¼šè†ç›–æ”¶ç´§ä¸Šæï¼Œç¡®ä¿å¤§è…¿å‰ä¾§æœ‰å¼ åŠ›ï¼›é¿å…æ”¯æ’‘è„šæŒªåŠ¨ã€‚');
          if(s2<8) tips.push('æŠ¬è…¿ä¸è´´åˆï¼šæŠ¬è†å‘å¤–ã€è„šå¿ƒè´´åœ¨æ”¯æ’‘è…¿â€œå°è…¿å†…ä¾§â€ï¼Œé¿å…è¸©è†ç›–æˆ–è½åœ°ã€‚');
          if(s3<8) tips.push('æ‰‹ä½ï¼šæŒå¿ƒå¯¹æŒå¿ƒï¼Œè…•éƒ¨é è¿‘èƒ¸ä¸­å¿ƒï¼Œè‚©é¢ˆæ”¾æ¾ä¸‹æ²‰ã€‚');
          if(s4<8) tips.push('å¹³è¡¡ä¸å®Œæ•´åº¦ï¼šè§†çº¿å¹³è§†ä¸€ç‚¹ï¼Œæ ¸å¿ƒæ”¶ç´§ï¼Œä¿æŒç¨³å®šæ»¡ 10 ç§’ã€‚');

          // å±•ç¤º
          finalized=true; running=false;
          scoreEl.textContent = total + ' åˆ†';
          scoreEl.className = 'score ' + (total>=85?'ok':(total>=60?'':'bad'));
          summaryEl.textContent = total>=85 ? 'å§¿åŠ¿è§„èŒƒï¼Œç»¼åˆè¡¨ç°ä¼˜è‰¯ã€‚' : (total>=60 ? 'åŸºæœ¬è¾¾æ ‡ï¼Œå»ºè®®æ ¹æ®æç¤ºå¾®è°ƒã€‚' : 'æœªè¾¾æ ‡ï¼Œè¯·æŒ‰æç¤ºé€é¡¹çº æ­£åå†è¯•ã€‚');
          tipsEl.innerHTML=''; tips.forEach(t=>{ const li=document.createElement('li'); li.textContent=t; tipsEl.appendChild(li); });
          resLayer.style.display='flex';
        }
      }
    }catch(e){
      statusEl.textContent='âš ï¸ æ£€æµ‹å¼‚å¸¸ï¼Œè¯·é‡è¯•';
    }
    requestAnimationFrame(loop);
  }

  // ========= åˆå§‹åŒ– =========
  async function init(){
    try{
      statusEl.textContent='ğŸ“· è¯·æ±‚æ‘„åƒå¤´â€¦';
      const stream = await navigator.mediaDevices.getUserMedia({
        audio:false, video:{facingMode:'user', width:CFG.width, height:CFG.height, frameRate:{ideal:CFG.fps,max:CFG.fps}}
      });
      video.srcObject = stream;
      await video.play();
      canvas.width = video.videoWidth||CFG.width;
      canvas.height = video.videoHeight||CFG.height;

      statusEl.textContent='ğŸ§  åŠ è½½æ¨¡å‹â€¦';
      await tf.setBackend(CFG.backend); await tf.ready();
      detector = await poseDetection.createDetector(
        poseDetection.SupportedModels.BlazePose,
        { runtime:'tfjs', modelType:CFG.modelType, enableSmoothing:true }
      );

      overlay.style.display='none';
      statusEl.textContent='å‡†å¤‡å°±ç»ªï¼šç«™å®š + èƒ¸å‰åˆåå¼€å§‹';
      running=true; finalized=false; armed=false; holdStart=null; swayEma=0; hipPrev=null; standFootStart=null;
      // ç”»å¸ƒåæ ‡ç³»é•œåƒ
      ctx.setTransform(1,0,0,1,0,0); ctx.translate(canvas.width,0); ctx.scale(-1,1);
      loop();
    }catch(e){
      statusEl.textContent='âŒ æ‘„åƒå¤´/æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™/ç½‘ç»œ';
    }
  }

  startBtn.addEventListener('click', init);
  retryBtn.addEventListener('click', ()=>{ resLayer.style.display='none'; finalized=false; armed=false; holdStart=null; swayEma=0; hipPrev=null; standFootStart=null; running=true; loop(); });
  closeBtn.addEventListener('click', ()=>{ resLayer.style.display='none'; });

})();
</script>
</body>
</html>
