<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>🧘 树式评估 · 自动评分（Lite）</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff;font-family:"PingFang SC",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden}
  .stage{position:relative;width:100vw;height:100vh}
  #video,#canvas{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
  #status,#hud,#fps{position:absolute;left:0;width:100%;text-align:center;z-index:10;text-shadow:0 2px 6px rgba(0,0,0,.6)}
  #status{top:12px;color:#4fc3f7;font-size:14px}
  #hud{top:40px;color:#fff;font-size:16px;font-weight:600}
  #fps{top:68px;color:#bbb;font-size:12px}
  #overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,.92);z-index:20}
  .title{font-size:22px;line-height:1.5;text-align:center}
  .subtitle{margin-top:8px;font-size:14px;color:#bbb;text-align:center;max-width:86vw}
  .controls{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);display:flex;flex-wrap:wrap;gap:10px;z-index:12;justify-content:center}
  button{background:#4fc3f7;color:#fff;border:none;padding:10px 14px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(79,195,247,.25)}
  button.ghost{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18)}
  .legend{position:absolute;right:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px 10px;font-size:12px;color:#ddd;z-index:11}
  .chip{position:absolute;left:12px;bottom:70px;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd;z-index:11}
  .tips{position:absolute;bottom:8px;width:100%;text-align:center;color:#aaa;font-size:12px}
  /* 结果面板 */
  #result{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:30;background:rgba(0,0,0,.65);backdrop-filter: blur(2px)}
  .card{max-width:560px;width:90vw;background:rgba(20,20,22,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px}
  .card h3{font-size:18px;margin-bottom:8px}
  .score{font-size:40px;font-weight:800;margin:6px 0 12px}
  .ok{color:#2ecc71}.bad{color:#ff6b6b}
  ul{margin:8px 0 0 18px;color:#ddd;font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .row>button{flex:1}
</style>
</head>
<body>
<div class="stage">
  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="status">⏳ 就绪中…</div>
  <div id="hud"></div>
  <div id="fps"></div>

  <div id="overlay">
    <div class="title">🧘 树式评估 · 自动评分</div>
    <div class="subtitle">为保证速度，本版仅加载 Pose 模型（不加载手部模型）。<br>启动方式：<b>站定 + 胸前合十</b>，保持静止<b>3秒</b>自动评分。</div>
    <div style="height:16px"></div>
    <button id="startBtn">👉 开启摄像头（Lite）</button>
    <div class="subtitle" style="margin-top:10px;">打不开？请用 HTTPS、换 4G/5G，或用 PC + 同一Wi-Fi下的内网IP访问。</div>
  </div>

  <div class="controls">
    <button id="switchBtn" class="ghost">切换前/后摄</button>
    <button id="freezeBtn" class="ghost">立即结算</button>
    <button id="saveJsonBtn" class="ghost">下载评分 JSON</button>
    <button id="shotBtn" class="ghost">保存截图</button>
    <button id="resetBtn" class="ghost">重新加载</button>
  </div>

  <div class="chip" id="peopleChip">人数：--</div>
  <div class="legend">维度：直腿 · 弯腿 · 髋外开 · 手位（合十） · 脚位高度 · 骨盆水平 · 稳定度</div>
  <div class="tips">全本地推理 · 不上传任何图像/视频</div>

  <!-- 结果弹层 -->
  <div id="result">
    <div class="card">
      <h3 id="resTitle">树式评估结果</h3>
      <div class="score" id="resScore">--</div>
      <div id="resSummary" style="font-size:14px;color:#ccc"></div>
      <ul id="resTips"></ul>
      <div class="row">
        <button id="retryBtn" class="ghost">↺ 重新测一次</button>
        <button id="closeBtn">完成</button>
      </div>
    </div>
  </div>
</div>

<script>
// 统一修改与简化版本
(async () => {
  const CFG = {
    backend: 'webgl',
    poseModelType: 'lite',  // 加速版Pose模型
    smoothing: true,

    video: { width: 640, height: 480, fps: 24 },  // 优化视频分辨率与帧率
    sampleEveryN: 1,  // 每帧都推理

    STRAIGHT_MIN: 165,   // 站立腿直度 165°
    BENT_MAX: 120,       // 抬腿弯曲最大值 120°
    VERT_MAX: 0.40,      // 垂直度限制
    PELVIS_TILT_MAX: 22, // 骨盆倾斜最大值
    HOLD_SEC: 3.0,       // 保持静止时间 3 秒后评分
    EMA_ALPHA: 0.3,
    STILL_SWAY_TH: 5,    // 摆动阈值

    PRAYER_WRIST_DIST: 70,   // 双手合十：手腕间距最大值
    PRAYER_CHEST_DIST: 140,  // 手腕至胸部最大距离

    FOOT_BONUS_AT_GROIN: 1.0,  // 脚跟接近大腿根部满分
    FOOT_OK_ABOVE_KNEE: 0.8,   // 高于膝盖的得分
    FOOT_ON_KNEE: 0.3,         // 脚踩在膝盖扣分
    FOOT_BELOW_KNEE: 0.1,      // 膝下更低扣分

    W: { straight: 20, bent: 15, hipOpen: 20, hands: 10, footHeight: 20, pelvis: 5, stability: 10 }
  };

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d', { alpha: true });
  const statusEl = document.getElementById('status');
  const hudEl = document.getElementById('hud');
  const resLayer = document.getElementById('result');
  const resTitle = document.getElementById('resTitle');
  const resScore = document.getElementById('resScore');
  const resSummary = document.getElementById('resSummary');
  const resTips = document.getElementById('resTips');
  const retryBtn = document.getElementById('retryBtn');
  const closeBtn = document.getElementById('closeBtn');
  const startBtn = document.getElementById('startBtn');
  const switchBtn = document.getElementById('switchBtn');
  const freezeBtn = document.getElementById('freezeBtn');
  const saveJsonBtn = document.getElementById('saveJsonBtn');
  const shotBtn = document.getElementById('shotBtn');
  const resetBtn = document.getElementById('resetBtn');
  const peopleChip = document.getElementById('peopleChip');

  let facing = 'user', stream = null, detector = null;
  let running = false, finalized = false, armed = false;
  let holdStart = null, lastCOM = null, swayEma = 0;
  let lastPose = null, lastFinal = null;
  let frameIndex = 0;

  // 启动摄像头
  async function startCamera() {
    statusEl.textContent = '📷 请求摄像头…';
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: { facingMode: facing, width: CFG.video.width, height: CFG.video.height, frameRate: { ideal: CFG.video.fps, max: CFG.video.fps } }
    });
    video.srcObject = stream; await video.play();
  }

  // 加载Pose模型
  async function loadModel() {
    statusEl.textContent = '🧠 加载Pose模型…';
    await tf.setBackend(CFG.backend);
    await tf.ready();
    detector = await poseDetection.createDetector(
      poseDetection.SupportedModels.BlazePose,
      { runtime: 'tfjs', modelType: CFG.poseModelType, enableSmoothing: CFG.smoothing }
    );
  }

  // 选择主要人物（最多2人）
  function pickPrimary(poses) {
    if (!poses?.length) return null;
    const center = { x: canvas.clientWidth / 2, y: canvas.clientHeight / 2 };
    const scored = poses.map(p => {
      const xs = p.keypoints.filter(k => k.score == null || k.score > 0.3).map(k => k.x);
      const ys = p.keypoints.filter(k => k.score == null || k.score > 0.3).map(k => k.y);
      if (!xs.length || !ys.length) return { p, score: -1 };
      const minx = Math.min(...xs), maxx = Math.max(...xs), miny = Math.min(...ys), maxy = Math.max(...ys);
      const area = (maxx - minx) * (maxy - miny);
      const cx = (minx + maxx) / 2, cy = (miny + maxy) / 2;
      const d = Math.hypot(cx - center.x, cy - center.y) + 1;
      return { p, score: area / d };
    }).sort((a, b) => b.score - a.score);
    return scored[0].p;
  }

  // 计算角度
  const dist = (a, b) => (a && b) ? Math.hypot(a.x - b.x, a.y - b.y) : null;
  const angleDeg = (a, b, c) => {
    if (!a || !b || !c) return null;
    const r = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let d = Math.abs(r * 180 / Math.PI);
    return d > 180 ? 360 - d : d;
  };

  // 绘制姿势
  function drawPoseCtx(g, kps) {
    if (!kps?.length) return;
    const edges = [
      [11, 13], [13, 15], [12, 14], [14, 16],
      [11, 12], [23, 24], [11, 23], [12, 24],
      [23, 25], [25, 27], [24, 26], [26, 28],
      [27, 29], [29, 31], [28, 30], [30, 32]
    ];
    g.lineWidth = 3;
    g.strokeStyle = 'rgba(79,195,247,.9)';
    g.fillStyle = '#fff';
    g.beginPath();
    for (const [a, b] of edges) {
      const p = kps[a], q = kps[b];
      if (p?.score > .3 && q?.score > .3) {
        g.moveTo(p.x, p.y);
        g.lineTo(q.x, q.y);
      }
    }
    g.stroke();
    for (const p of kps) {
      if (p?.score > .3) {
        g.beginPath();
        g.arc(p.x, p.y, 4, 0, Math.PI * 2);
        g.fill();
      }
    }
  }

  // 树式姿势评分
  function scoreTree(kps) {
    const lh = kps[23], rh = kps[24], lk = kps[25], rk = kps[26], la = kps[27], ra = kps[28], ls = kps[11], rs = kps[12];
    if (!lh || !rh || !lk || !rk || !la || !ra) return { score: 0, problems: ['关键点不足'], detail: {} };

    const LKA = angleDeg(lh, lk, la), RKA = angleDeg(rh, rk, ra);
    const straight = Math.max(LKA, RKA);
    const bent = Math.min(LKA, RKA);

    const footHeightScore = Math.abs(la.y - ra.y) > 20 ? 0 : 1;
    const stabilityScore = Math.abs(lh.y - rh.y) < 10 ? 1 : 0;

    const score = (straight > 160 ? 1 : 0) * 40 + (bent < 120 ? 1 : 0) * 30 + footHeightScore * 20 + stabilityScore * 10;

    const problems = [];
    if (straight < 160) problems.push('站立腿不够直');
    if (bent > 120) problems.push('抬腿膝盖角度过大');
    if (footHeightScore === 0) problems.push('脚放得太低');
    if (stabilityScore === 0) problems.push('骨盆不稳定');

    return { score: Math.round(score), problems };
  }

  // 最终评分显示
  function finalize(res) {
    finalized = true;
    running = false;
    const s = res.score;
    resTitle.textContent = '树式评估结果';
    resScore.textContent = `${s} 分`;
    resScore.className = 'score ' + (s >= 80 ? 'ok' : (s >= 60 ? '' : 'bad'));
    resSummary.textContent = s >= 80 ? '姿势规范，保持良好！' : (s >= 60 ? '基本达标，注意细节调整。' : '未达标，建议根据提示逐项纠正。');
    resTips.innerHTML = '';
    (res.problems?.length ? res.problems : ['无明显问题点']).forEach(t => {
      const li = document.createElement('li');
      li.textContent = t;
      resTips.appendChild(li);
    });
    lastFinal = {
      timestamp: new Date().toISOString(),
      score: s,
      problems: res.problems,
      detail: res.detail,
      config: CFG
    };
    resLayer.style.display = 'flex';
  }

  // 摄像头初始化与流程
  async function init() {
    await startCamera();
    await loadModel();
    running = true;
    statusEl.textContent = '准备就绪，站定并合十开始评分';
  }

  // 启动评分流程
  startBtn.addEventListener('click', init);

  // 重新加载
  resetBtn.addEventListener('click', () => {
    location.reload();
  });

  // 自动评分时触发
  freezeBtn.addEventListener('click', () => {
    if (finalized) return;
    if (!lastPose?.keypoints?.length) {
      statusEl.textContent = '暂未检测到人体';
      return;
    }
    finalize(scoreTree(lastPose.keypoints));
  });

})();
</script>
</body>
</html>
