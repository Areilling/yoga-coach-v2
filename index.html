<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>ğŸ§˜ æ™ºæ…§ä½“è‚² Â· ç‘œä¼½è¯„ä¼°</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.12.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.12.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.12.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0/dist/pose-detection.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "PingFang SC", sans-serif;
      background: #000;
      color: white;
      overflow: hidden;
      touch-action: none;
    }
    #video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      transform: scaleX(-1);
      display: block;
    }
    #overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.95);
      z-index: 10;
    }
    #startBtn {
      background: #4fc3f7;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 12px;
      font-size: 20px;
      cursor: pointer;
      margin-top: 20px;
      font-weight: bold;
    }
    .instructions {
      position: absolute;
      bottom: 20px;
      text-align: center;
      font-size: 14px;
      color: #aaa;
      width: 100%;
    }
    #status, #feedback {
      position: absolute;
      width: 100%;
      text-align: center;
      z-index: 20;
      font-size: 18px;
    }
    #status { top: 20px; color: #4fc3f7; }
    #feedback { top: 60px; color: white; }
  </style>
</head>
<body>
  <video id="video" playsinline muted></video>
  <div id="status">â³ åŠ è½½ä¸­...</div>
  <div id="feedback"></div>
  
  <div id="overlay">
    <div style="text-align: center; color: white; font-size: 24px; max-width: 80%;">
      ğŸ§˜ æ™ºæ…§ä½“è‚² Â· ç‘œä¼½è¯„ä¼°<br>
      <span style="font-size: 16px; color: #bbb; margin-top: 10px; display: block;">
        è¯·åœ¨å…‰çº¿å……è¶³å¤„ä½¿ç”¨
      </span>
    </div>
    <button id="startBtn">ğŸ‘‰ ç‚¹å‡»å¼€å§‹æ‘„åƒå¤´</button>
  </div>
  <div class="instructions">å¾®ä¿¡æ‰«ç ä½¿ç”¨ Â· æ•°æ®ä»…åœ¨æœ¬åœ°å¤„ç†</div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const startBtn = document.getElementById('startBtn');
    const statusEl = document.getElementById('status');
    const feedbackEl = document.getElementById('feedback');

    startBtn.addEventListener('click', async () => {
      try {
        statusEl.textContent = 'ğŸ“· è¯·æ±‚æ‘„åƒå¤´...';
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: 640, height: 480 },
          audio: false
        });
        video.srcObject = stream;
        overlay.style.display = 'none';
        await video.play();

        statusEl.textContent = 'ğŸ§  åŠ è½½AIæ¨¡å‹ï¼ˆå®Œæ•´ç‰ˆï¼‰...';
        await tf.setBackend('webgl');
        
        // ğŸ‘‡ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ full æ¨¡å‹ï¼Œç¡®ä¿å…³é”®ç‚¹è¾“å‡º
        const detector = await poseDetection.createDetector(
          poseDetection.SupportedModels.BlazePose,
          { 
            runtime: 'tfjs',
            modelType: 'full',   // â† æ”¹ä¸º full
            enableSmoothing: true
          }
        );

        statusEl.textContent = 'âœ… å‡†å¤‡å°±ç»ªï¼è¯·åšç‘œä¼½...';
        feedbackEl.textContent = '';

        const detect = async () => {
          try {
            const poses = await detector.estimatePoses(video);
            
            if (poses.length === 0) {
              feedbackEl.textContent = 'æœªæ£€æµ‹åˆ°äººä½“ï¼Œè¯·å¯¹å‡†é•œå¤´';
              requestAnimationFrame(detect);
              return;
            }

            const pose = poses[0];
            // ğŸ” å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ keypoints
            if (!pose.keypoints || pose.keypoints.length === 0) {
              feedbackEl.textContent = 'âš ï¸ æ£€æµ‹ä¸­...è¯·ä¿æŒé™æ­¢';
              requestAnimationFrame(detect);
              return;
            }

            // âœ… æœ‰å…³é”®ç‚¹ï¼Œè¿›è¡Œè¯„ä¼°
            evaluatePose(pose.keypoints, feedbackEl);
            requestAnimationFrame(detect);
          } catch (e) {
            console.error(e);
            feedbackEl.textContent = 'âŒ æ£€æµ‹å¼‚å¸¸ï¼Œè¯·é‡è¯•';
          }
        };
        detect();
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'âŒ å¯åŠ¨å¤±è´¥';
        feedbackEl.innerHTML = `<button onclick="location.reload()" style="background:#ff6b6b;color:white;border:none;padding:10px 20px;border-radius:8px;">é‡è¯•</button>`;
      }
    });

    function calculateAngle(a, b, c) {
      if (!a || !b || !c) return 0;
      const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
      let angle = Math.abs(radians * 180 / Math.PI);
      return angle > 180 ? 360 - angle : angle;
    }

    function getPoint(keypoints, index) {
      const kp = keypoints[index];
      return kp && kp.score > 0.3 ? { x: kp.x, y: kp.y } : null;
    }

    function evaluatePose(keypoints, feedbackEl) {
      const leftHip = getPoint(keypoints, 23);
      const rightHip = getPoint(keypoints, 24);
      const leftKnee = getPoint(keypoints, 25);
      const rightKnee = getPoint(keypoints, 26);
      const leftAnkle = getPoint(keypoints, 27);
      const rightAnkle = getPoint(keypoints, 28);

      if (!leftHip || !rightHip || !leftKnee || !rightKnee) {
        feedbackEl.textContent = 'è¯·ä¿æŒå…¨èº«å¯è§';
        return;
      }

      const leftKneeAngle = calculateAngle(leftHip, leftKnee, leftAnkle);
      const rightKneeAngle = calculateAngle(rightHip, rightKnee, rightAnkle);

      // æ ‘å¼ï¼šä¸€æ¡è…¿å¼¯æ›²ï¼ˆ<120Â°ï¼‰ï¼Œå¦ä¸€æ¡ä¼¸ç›´ï¼ˆ>160Â°ï¼‰
      if ((leftKneeAngle < 120 && rightKneeAngle > 160) || (rightKneeAngle < 120 && leftKneeAngle > 160)) {
        feedbackEl.innerHTML = 'âœ… å•è…¿å¹³è¡¡<br>âœ… éª¨ç›†ç¨³å®š';
        return;
      }

      feedbackEl.textContent = 'è¯·å°è¯•æ ‘å¼ï¼ˆå•è…¿ç«™ç«‹ï¼‰';
    }
  </script>
</body>
</html>
